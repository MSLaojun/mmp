<!DOCTYPE html>

<html>
    <head>
        <meta charset="UTF-8">
        <title>Mmap</title>
        <meta name="description" content="Electron app to draw original mind maps">
        <link href="test.css" rel="stylesheet">
    </head>
    <body>

        <div class="sidebar">
            <h3>mmap.js</h3>
            <table>
                <tr>
                    <td>Node name :</td>
                    <td><input id="node-name" type="text" name="node-name"></td>
                </tr>
                <tr>
                    <td>Add node :</td>
                    <td><img onclick="mmap.node.add()" src="img/add.svg"></td>
                </tr>
                <tr>
                    <td>Remove node :</td>
                    <td><img onclick="mmap.node.remove()" src="img/remove.svg"></td>
                </tr>
                <tr>
                    <td>Undo :</td>
                    <td><img onclick="mmap.undo()" src="img/undo.svg"></td>
                </tr>
                <tr>
                    <td>Repeat :</td>
                    <td><img onclick="mmap.repeat()" src="img/repeat.svg"></td>
                </tr>
                <tr>
                    <td>Center :</td>
                    <td><img onclick="mmap.center()" src="img/center.svg"></td>
                </tr>
                <tr>
                    <td>New map :</td>
                    <td><img onclick="mmap.new()" src="img/new.svg"></td>
                </tr>
                <tr>
                    <td>Get image :</td>
                    <td><img onclick="mmap.png('mmap')" src="img/img.svg"></td>
                </tr>
                <tr>
                    <td>Save map :</td>
                    <td><img id="save-map" src="img/save.svg"></td>
                </tr>
                <tr>
                    <td>Upload map :</td>
                    <td><img id="upload-map" src="img/upload.svg"></td>
                </tr>
                <tr>
                    <td>Node color :</td>
                    <td><input class="color-btn" type="color" name="background-color"
                        onchange="mmap.node.update('background-color', value)"></td>
                </tr>
                <tr>
                    <td>Branch color :</td>
                    <td><input class="color-btn" type="color" name="branch-color"
                        onchange="mmap.node.update('branch-color', value)"></td>
                </tr>
                <tr>
                    <td>Text color :</td>
                    <td><input class="color-btn" type="color" name="text-color"
                        onchange="mmap.node.update('text-color', value)"></td>
                </tr>
                <tr>
                    <td>Font size :</td>
                    <td><input id="font-size" type="text" name="font-size"></td>
                </tr>
                <tr>
                    <td>Bold font :</td>
                    <td><input id="bold-font" onchange="mmap.node.update('font-weight')" type="checkbox"></td>
                </tr>
                <tr>
                    <td>Italic font :</td>
                    <td><input id="italic-font" onchange="mmap.node.update('font-style')" type="checkbox"></td>
                </tr>
                <tr>
                    <td>Fixed node :</td>
                    <td><input id="fixed-node" onchange="mmap.node.update('fixed')" type="checkbox"></td>
                </tr>
                <input style="display:none" type="file" id="upload" accept=".mmap">
            </table>
        </div>

        <div class="mmap"></div>

        <script src="../bower_components/d3/d3.min.js"></script>
        <script src="../dist/mmap.js"></script>
        <script>

            // DOM elements
            const nodeName = document.getElementById('node-name');
            const fontSize = document.getElementById('font-size');
            const fixedNode = document.getElementById('fixed-node');
            const italicFont = document.getElementById('italic-font');
            const boldFont = document.getElementById('bold-font');
            const saveMap = document.getElementById('save-map');
            const uploadMap = document.getElementById('upload-map');
            const upload = document.getElementById('upload');
            const backgroundColor = document.getElementsByClassName('color-btn')[0];
            const branchColor = document.getElementsByClassName('color-btn')[1];
            const textColor = document.getElementsByClassName('color-btn')[2];

            fontSize.onkeyup = function() {
                mmap.node.update('font-size', fontSize.value );
            }

            nodeName.onblur = function() {
                if( nodeName.value === '' ) mmap.node.update('name', nodeName.value = 'Node');
            }

            nodeName.onkeyup = function( e ) {
                e.key === "Enter" ? nodeName.blur() : mmap.node.update('name', nodeName.value );
            };

            saveMap.onclick = function() {
                const data = mmap.data();
                const json = JSON.stringify( data );
                const blob = new Blob([ json ], { type: "application/json" });
                const a = document.createElement('a');
                a.download = "mymap.mmap";
                a.href = URL.createObjectURL( blob );
                a.click();
            }

            uploadMap.onclick = function() {
                upload.click();
            }
            upload.onchange = function( e ) {
                var reader = new FileReader();
                reader.readAsText( e.target.files[0] );
                reader.onload = function( e ) {
                    var data = JSON.parse( event.target.result );
                    mmap.load( data );
                };
            }

            // mmap events

            mmap.events.on('mmcreate', function(){
                console.log('Mindmap created!');
            });

            mmap.events.on('nodeselect', function( key, value ) {
                nodeName.value = value['name'];
                fontSize.value = value['font-size'];
                backgroundColor.value = value['background-color'];
                branchColor.value = value['branch-color'] || '#ffffff';
                textColor.value = value['text-color'];
                italicFont.checked = value['font-style'] === 'italic';
                boldFont.checked = value['font-weight'] === 'bold';
                fixedNode.checked = value.fixed === true;
                console.log('The node \"'+ key +'\" has been selected');
            });

            mmap.events.on('nodeupdate', function( key, value, property ) {
                console.log('The node \"'+ key +'\" has updated its property \"'+ property + '\"');
            });

            mmap.events.on('nodefocus', function( key, value ) {
                console.log('The node \"'+ key +'\" has been focused');
                nodeName.focus();
            });

            mmap.init('.mmap');

        </script>
    </body>
</html>
