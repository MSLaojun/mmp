!function(e,t){function n(n){X.container=t.select(n),X.history={index:-1,snapshots:[]},X.svg={},X.svg.main=X.container.append("svg").attr("width","100%").attr("height","100%").call(G),X.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",a),X.svg.mmap=X.svg.main.append("g"),X.nodes=t.map(),X.counter=0,m(),w(),p(),a(),P(),e.onresize=V,Q.call("mmcreate")}function o(){X.svg.mmap.attr("transform",t.event.transform)}function s(e,t){var n;return n=e.x>t.x?1:e.x<t.x?-1:Math.random()>=.5?-1:1,e.x+200*n}function r(e,n){const o=X.nodes.values(),s=o.filter(e=>e.parent===X.selected);for(var r,c,l=-3;!r;){c=e.y+40*l,r=!0;for(var i in s){const e=s[i],t=1.5*e.height;if(r=!(c<e.y+t&&c>e.y-t),!r)break}l=l===-1?l+2:l+1,l>3&&(r=!0,c=e.y-200+t.randomUniform(-20,20)())}return c}function c(e){X.dragged=!0;const n=e.value.x+=t.event.dx,o=e.value.y+=t.event.dy;t.select(this).attr("transform","translate("+[n,o]+")"),t.selectAll(".branch").attr("d",E)}function l(e){if(X.selected!==e||"node0"===X.selected){t.selectAll(".node > path").style("stroke","none"),X.selected=e;const n=t.select("#"+e),o=n.select("path");o.style("stroke",t.color(o.style("fill")).darker(.5)),Q.call("nodeselect",n.node(),X.nodes.get(e))}}function i(){const e=t.select("#"+X.selected),n=e.select("path");n.style("stroke",t.color(n.style("fill")).darker(.5));const o=new MouseEvent("dblclick");e.node().dispatchEvent(o)}function a(){l("node0"),t.select("#node0 > path").style("stroke","none")}function d(e){for(var t=e.parent,n=0;t;){n++;const e=X.nodes.get(t);t=e.parent}return n}function f(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const r=n[o].cssRules;for(var s=0;s<r.length;s++){const n=r[s],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function u(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function h(){const t=X.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=t.getBBox(),s=15,r=o.x-s,c=o.y-s,l=o.width+30,i=o.height+30,a="http://www.w3.org/2000/xmlns/";n.setAttributeNS(a,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(a,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",l),n.setAttribute("height",i),n.setAttribute("viewBox",[r,c,l,i].join(" "));const d=f(t),h=document.createElement("style"),m=document.createElement("defs");h.setAttribute("type","text/css"),h.innerHTML="<![CDATA[\n"+d+"\n]]>",m.appendChild(h),n.appendChild(m);const g=t.cloneNode(!0);g.setAttribute("transform","translate(0,0)"),n.appendChild(g);const y=e.btoa(u(n.outerHTML));return"data:image/svg+xml;base64,"+y}function m(){X.nodes.set("node"+X.counter,{name:"Root node",x:parseInt(X.container.style("width"))/2,y:parseInt(X.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function g(){const e=e=>parseInt(e.substring(4)),t=X.nodes.keys().map(e);X.counter=Math.max(...t)}function y(e){const n=t.map();return e.forEach(function(e){n.set(e.key,Object.assign({},e.value))}),n}function p(){const e=X.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1);const t=JSON.parse(JSON.stringify(X.nodes.entries()));e.snapshots.push(t),e.index++}function x(e){X.nodes=y(e),v(),a(),g()}function v(){t.selectAll(".node, .branch").remove(),w()}function w(){const e=X.nodes.entries(),n=X.svg.mmap.selectAll(".node").data(e),o=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.value.x+","+e.value.y+")").call(K).on("dblclick",function(e){Q.call("nodedblclick",this,e),t.event.stopPropagation()});o.append("text").text(e=>e.value.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",e=>e.value["text-color"]).style("font-size",e=>e.value["font-size"]).style("font-style",e=>e.value["font-style"]).style("font-weight",e=>e.value["font-weight"]),o.insert("path","text").style("fill",e=>e.value["background-color"]).style("stroke-width",3).attr("d",I),n.exit().remove();const s=X.svg.mmap.selectAll(".branch").data(e.slice(1));s.enter().insert("path","g").style("fill",e=>e.value["branch-color"]).style("stroke",e=>e.value["branch-color"]).attr("class","branch").attr("id",e=>"branchOf"+e.key).attr("d",E),s.exit().remove()}function b(e,n){if(e.name!=n){const o=this.childNodes[1],s=this.childNodes[0];e.name=o.innerHTML=n,e.width=o.textLength.baseVal.value+45,t.select(s).attr("d",I),p()}}function k(e,n){if(e["background-color"]!==n){const o=this.childNodes[0];o.style.setProperty("fill",e["background-color"]=n),o.style.setProperty("stroke",t.color(n).darker(.5)),p()}}function z(e,t){if(e["text-color"]!==t){const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t),p()}}function A(e,n){if(e["font-size"]!=n){const o=this.childNodes[1],s=this.childNodes[0];o.style.setProperty("font-size",e["font-size"]=n),e.width=o.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,t.select(s).attr("d",I),t.selectAll(".branch").attr("d",E),p()}}function N(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"]),p()}function C(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"]),p()}function T(e,t){if("node0"!==X.selected){if(e["branch-color"]!==t){const n=document.getElementById("branchOf"+X.selected);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t),p()}}else console.warn("The root node has no branches")}function E(e){const n=e.value,o=X.nodes.get(n.parent),s=d(n),r=22-3*(s<5?s:5),c=(o.x+n.x)/2,l=o.y<n.y+n.height/2?-1:1,i=o.x>n.x?-1:1,a=i*l,f=t.path();return f.moveTo(o.x,o.y-.8*r),f.bezierCurveTo(c-r*a,o.y-r/2,o.x-r/2*a,n.y+n.height/2-r/3,n.x-n.width/3*i,n.y+n.height/2+3),f.bezierCurveTo(o.x+r/2*a,n.y+n.height/2+r/3,c+r*a,o.y+r/2,o.x,o.y+.8*r),f.closePath(),f}function I(e){const n=e.value,o=t.path(),s=(n.width=this.nextSibling.getBBox().width+45)/2,r=(n.height=11*n["font-size"]/10+30)/2,c=n.k=n.k||t.randomUniform(-20,20)();return o.moveTo(-s,c/3),o.bezierCurveTo(-s,-r+10,-s+10,-r,c,-r),o.bezierCurveTo(s-10,-r,s,-r+10,s,c/3),o.bezierCurveTo(s,r-10,s-10,r,c,r),o.bezierCurveTo(-s+10,r,-s,r-10,-s,c/3),o.closePath(),o}function P(e,t){var n={},o=function(){return S(arguments,n)};onkeyup=onkeydown=function(e){if(n[e.keyCode]="keydown"===e.type,o("ctrl","maiusc","z"))return!!_();if(o("ctrl","z"))return!!J();if(o("ctrl","maiusc","up"))U("up");else if(o("ctrl","maiusc","down"))U("down");else if(o("ctrl","maiusc","left"))U("left");else if(o("ctrl","maiusc","right"))U("right");else{if(o("alt","up"))return!!B("up");if(o("alt","down"))return!!B("down");if(o("alt","right"))return!!B("right");if(o("alt","left"))return!!B("left");if(o("alt","i"))j("mmap");else if(o("alt","c"))V();else if(o("alt","n"))D();else if(o("alt","+"))O();else if(o("alt","-"))R();else{if(o("alt","f"))return!!i();o("esc")&&a()}}}}function S(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,f:70,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function L(e){const t=X.nodes.get(X.selected),n=X.nodes.get("node0"),o=d(t),s=n.x>t.x;var r,c=Number.MAX_VALUE;return X.nodes.each(function(l,i){const a=e?t.y-l.y:l.y-t.y,f=o===d(l),u=X.selected===i,h=s&&n.x>l.x||!s&&n.x<l.x;h&&f&&!u&&a>0&&a<c&&(c=a,r=i)}),r||X.selected}function M(e){const t=X.nodes.get(X.selected),n=X.nodes.get("node0");var o,s,r=Number.MIN_VALUE;return X.nodes.each(function(c,l){s=t.x<n.x?e?c.parent===X.selected:t.parent===l:t.x>n.x?e?t.parent===l:c.parent===X.selected:(e?c.x<n.x:c.x>n.x)&&c.parent===X.selected,s&&c.y>r&&(r=c.y,o=l)}),o||X.selected}function B(e){l({up:L,down:L,left:M,right:M}[e]("up"===e||"left"===e))}function U(e){const n=X.nodes.get(X.selected),o=t.select("#"+X.selected),s=10;switch(e){case"up":n.y-=s;break;case"down":n.y+=s;break;case"right":n.x+=s;break;case"left":n.x-=s}o.attr("transform",e=>"translate("+e.value.x+","+e.value.y+")"),t.selectAll(".branch").attr("d",E),p()}function O(e){if(X.selected){const t=X.nodes.get(X.selected),n=X.nodes.get("node0"),o="node"+ ++X.counter,c={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f1f1f1","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||t["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",x:s(t,n),y:r(t,n),parent:X.selected};X.nodes.set(o,c),w(),Q.call("nodecreate"),p()}}function R(){if("node0"!==X.selected){X.nodes.remove(X.selected);const e=function(t){X.nodes.each(function(n,o){if("node0"!==n.key&&n.parent===t)return X.nodes.remove(o),void e(o)})};e(X.selected),l("node0"),v(),Q.call("noderemove"),p()}else console.warn("The root node can not be deleted")}function V(){const e=X.nodes.get("node0"),n={x:parseInt(X.container.style("width"))/2,y:parseInt(X.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);X.svg.main.transition().duration(500).call(G.transform,o),Q.call("mmcenter")}function H(e,t){const n=X.nodes.get(X.selected),o=document.getElementById(X.selected),s={name:b,"background-color":k,"branch-color":T,"text-color":z,"font-size":A,"font-style":N,"font-weight":C,default:function(){console.error('"'+e+'" is not a valid node property')}};(s[e]||s.default).call(o,n,t)}function j(e,t){const n=new Image;n.src=h(),n.onload=function(){const o=document.createElement("canvas"),s=o.getContext("2d"),r=document.createElement("a");o.width=n.width,o.height=n.height,s.drawImage(n,0,0),s.globalCompositeOperation="destination-over",s.fillStyle=t||"#ffffff",s.fillRect(0,0,o.width,o.height),r.download=e,r.href=o.toDataURL("image/png"),r.click()}}function D(){X.counter=0,X.nodes.clear(),m(),v(),p(),a(),V()}function J(){const e=X.history;e.index>0&&(e.index--,x(e.snapshots[e.index]))}function _(){const e=X.history;e.index<e.snapshots.length-1&&(e.index++,x(e.snapshots[e.index]))}function q(){return X.history.snapshots[X.history.index]}function F(e){x(e),p()}const X={},G=t.zoom().scaleExtent([.5,2]).on("zoom",o),K=t.drag().on("drag",c).on("start",function(e){l(e.key)}).on("end",function(){X.dragged&&(X.dragged=!1,p())}),Q=t.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");e.mmap={init:n,center:V,undo:J,repeat:_,new:D,events:Q,png:j,data:q,load:F,addNode:O,removeNode:R,updateNode:H}}(this,window.d3);