!function(e,t){"use strict";function n(n){Y.container=t.select(n),Y.history={index:-1,snapshots:[]},Y.svg={},Y.svg.main=Y.container.append("svg").attr("width","100%").attr("height","100%").call(Z),Y.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",f),Y.svg.mmap=Y.svg.main.append("g"),Y.nodes=t.map(),Y.counter=0,x(),A(),b(),U(),ee.call("mmcreate"),e.onresize=q,f()}function o(){Y.svg.mmap.attr("transform",t.event.transform)}function s(e,t){var n;if(e.x>t.x)n=1;else if(e.x<t.x)n=-1;else{const e=e=>"node0"===e.parent,t=Y.nodes.values().filter(e).length;n=t%2===0?-1:1}return e.x+200*n}function r(e){return e<Y.nodes.get("node0").x}function c(e){return console.error(e),!1}function i(e,t,n){e.setAttribute("transform","translate("+[t,n]+")")}function l(e){const n=t.event.dy,o=t.event.dx,s=e.value.x+=o,c=e.value.y+=n,l=e,d=r(s)===r(s-o);i(this,s,c),e.value.fixed&&a(e.key,function(e,t){const s=e.x+=o,r=e.y+=n;d||(e.x+=2*(l.value.x-e.x)),i(this,s,r)}),t.selectAll(".branch").attr("d",S),Y.dragged=!0}function a(e,t){Y.nodes.each(function(n,o){n.parent===e&&(t.call(document.getElementById(o),n,o),a(o,t))})}function d(e){if(Y.selected!==e||"node0"===Y.selected){t.selectAll(".node > path").style("stroke","none"),Y.selected=e;const n=t.select("#"+e),o=n.select("path");o.style("stroke",t.color(o.style("fill")).darker(.5)),ee.call("nodeselect",n.node(),e,Y.nodes.get(e))}}function u(){const e=t.select("#"+Y.selected),n=e.select("path");n.style("stroke",t.color(n.style("fill")).darker(.5)),e.node().dispatchEvent(new MouseEvent("dblclick"))}function f(){d("node0"),t.select("#node0 > path").style("stroke","none")}function h(e){for(var t=e.parent,n=0;t;){n++;const e=Y.nodes.get(t);t=e.parent}return n}function m(e){return Object.assign({},e)}function y(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const r=n[o].cssRules;for(var s=0;s<r.length;s++){const n=r[s],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function g(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function p(){const t=Y.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o="http://www.w3.org/2000/xmlns/",s=t.getBBox(),r=15,c=s.x-r,i=s.y-r,l=s.width+30,a=s.height+30;n.setAttributeNS(o,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(o,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",l),n.setAttribute("height",a),n.setAttribute("viewBox",[c,i,l,a].join(" "));const d=y(t),u=document.createElement("style"),f=document.createElement("defs");u.setAttribute("type","text/css"),u.innerHTML="<![CDATA[\n"+d+"\n]]>",f.appendChild(u),n.appendChild(f);const h=t.cloneNode(!0);h.setAttribute("transform","translate(0,0)"),n.appendChild(h);const m=e.btoa(g(n.outerHTML));return"data:image/svg+xml;base64,"+m}function x(){Y.nodes.set("node"+Y.counter,{name:"Root node",fixed:!1,x:parseInt(Y.container.style("width"))/2,y:parseInt(Y.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function v(){const e=e=>parseInt(e.substring(4)),t=Y.nodes.keys().map(e);Y.counter=Math.max(...t)}function w(){return Y.nodes.entries().map(function(e){return{key:e.key,value:m(e.value)}})}function b(){const e=Y.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1),e.snapshots.push(w()),e.index++}function k(e){Y.nodes.clear(),e.forEach(function(e){Y.nodes.set(e.key,m(e.value))}),z(),f(),v()}function z(){t.selectAll(".node, .branch").remove(),A()}function A(){const e=Y.nodes.entries(),n=Y.svg.mmap.selectAll(".node").data(e),o=Y.svg.mmap.selectAll(".branch").data(e.slice(1)),s=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.value.x+","+e.value.y+")").call($).on("dblclick",function(e){ee.call("nodefocus",this,e.key,e.value),t.event.stopPropagation()});s.append("text").text(e=>e.value.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",e=>e.value["text-color"]).style("font-size",e=>e.value["font-size"]).style("font-style",e=>e.value["font-style"]).style("font-weight",e=>e.value["font-weight"]),s.insert("path","text").style("fill",e=>e.value["background-color"]).style("stroke-width",3).attr("d",M),o.enter().insert("path","g").style("fill",e=>e.value["branch-color"]).style("stroke",e=>e.value["branch-color"]).attr("class","branch").attr("id",e=>"branchOf"+e.key).attr("d",S),n.exit().remove(),o.exit().remove()}function T(e,n){if(e.name==n)return!1;{const o=this.childNodes[1],s=this.childNodes[0];e.name=o.innerHTML=n,e.width=o.textLength.baseVal.value+45,t.select(s).attr("d",M),b()}}function C(e,n){if(e["background-color"]===n)return!1;{const o=this.childNodes[0];o.style.setProperty("fill",e["background-color"]=n),o.style.setProperty("stroke",t.color(n).darker(.5)),b()}}function N(e,t){if(e["text-color"]===t)return!1;{const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t),b()}}function E(e,n){if(e["font-size"]==n)return!1;{const o=this.childNodes[1],s=this.childNodes[0];o.style.setProperty("font-size",e["font-size"]=n),e.width=o.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,t.select(s).attr("d",M),t.selectAll(".branch").attr("d",S),b()}}function I(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"]),b()}function P(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"]),b()}function B(e,t){if("node0"===Y.selected)return c("The root node has no branches");if(e["branch-color"]===t)return!1;{const n=document.getElementById("branchOf"+Y.selected);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t),b()}}function L(e){return"node0"===Y.selected?c("The root node can not be fixed"):void(e.fixed=!e.fixed)}function S(e){const n=e.value,o=Y.nodes.get(n.parent),s=h(n),r=22-3*(s<5?s:5),c=(o.x+n.x)/2,i=o.y<n.y+n.height/2?-1:1,l=o.x>n.x?-1:1,a=l*i,d=t.path();return d.moveTo(o.x,o.y-.8*r),d.bezierCurveTo(c-r*a,o.y-r/2,o.x-r/2*a,n.y+n.height/2-r/3,n.x-n.width/3*l,n.y+n.height/2+3),d.bezierCurveTo(o.x+r/2*a,n.y+n.height/2+r/3,c+r*a,o.y+r/2,o.x,o.y+.8*r),d.closePath(),d}function M(e){const n=e.value,o=t.path(),s=(n.width=this.nextSibling.getBBox().width+45)/2,r=(n.height=11*n["font-size"]/10+30)/2,c=n.k=n.k||t.randomUniform(-20,20)();return o.moveTo(-s,c/3),o.bezierCurveTo(-s,-r+10,-s+10,-r,c,-r),o.bezierCurveTo(s-10,-r,s,-r+10,s,c/3),o.bezierCurveTo(s,r-10,s-10,r,c,r),o.bezierCurveTo(-s+10,r,-s,r-10,-s,c/3),o.closePath(),o}function U(e,t){const n={},o=function(){return R(arguments,n)};onkeyup=onkeydown=function(e){if(n[e.keyCode]="keydown"===e.type,o("ctrl","maiusc","z"))return!!K();if(o("ctrl","z"))return!!J();if(o("ctrl","maiusc","up"))j("up");else if(o("ctrl","maiusc","down"))j("down");else if(o("ctrl","maiusc","left"))j("left");else if(o("ctrl","maiusc","right"))j("right");else{if(o("alt","up"))return!!H("up");if(o("alt","down"))return!!H("down");if(o("alt","right"))return!!H("right");if(o("alt","left"))return!!H("left");if(o("alt","i"))X("mmap");else if(o("alt","c"))q();else if(o("alt","n"))G();else if(o("alt","+"))D();else if(o("alt","-"))_();else{if(o("alt","f"))return!!u();o("esc")&&f()}}}}function R(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,f:70,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function O(e){const t=Y.nodes.get(Y.selected),n=h(t),o=r(t.x);var s,c=Number.MAX_VALUE;Y.nodes.each(function(i,l){const a=e?t.y-i.y:i.y-t.y,d=n===h(i),u=Y.selected===l,f=o===r(i.x);f&&d&&!u&&a>0&&a<c&&(c=a,s=l)}),void 0!==s&&d(s)}function V(e){const t=Y.nodes.get(Y.selected),n=Y.nodes.get("node0");var o,s,r=Number.MIN_VALUE;Y.nodes.each(function(c,i){s=t.x<n.x?e?c.parent===Y.selected:t.parent===i:t.x>n.x?e?t.parent===i:c.parent===Y.selected:(e?c.x<n.x:c.x>n.x)&&c.parent===Y.selected,s&&c.y>r&&(r=c.y,o=i)}),void 0!==o&&d(o)}function H(e){const t="up"===e||"left"===e;"up"===e||"down"===e?O(t):V(t)}function j(e){const n=Y.nodes.get(Y.selected),o=10,s=r(n.x),c={up:e=>e.y-=o,down:e=>e.y+=o,right:e=>e.x+=o,left:e=>e.x-=o};c[e](n);const l=r(n.x);i(document.getElementById(Y.selected),n.x,n.y),n.fixed&&a(Y.selected,function(t,o){c[e](t),l!==s&&(t.x+=2*(n.x-t.x)),i(this,t.x,t.y)}),t.selectAll(".branch").attr("d",S),b()}function D(e){const n=Y.nodes.get(Y.selected),o=Y.nodes.get("node0"),r="node"+ ++Y.counter,c={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f9f9f9","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||n["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",fixed:e&&e.fixed||!0,x:e&&e.x||s(n,o),y:e&&e.y||n.y-t.randomUniform(60,100)(),parent:Y.selected};Y.nodes.set(r,c),A(),ee.call("nodecreate"),b()}function _(){const e=Y.selected;return"node0"===e?c("The root node can not be deleted"):(Y.nodes.remove(e),a(e,function(e,t){Y.nodes.remove(t)}),d("node0"),z(),b(),ee.call("noderemove",this,e),void 0)}function q(){const e=Y.nodes.get("node0"),n={x:parseInt(Y.container.style("width"))/2,y:parseInt(Y.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);Y.svg.main.transition().duration(500).call(Z.transform,o),ee.call("mmcenter")}function F(e,t){const n=Y.nodes.get(Y.selected),o=document.getElementById(Y.selected),s={name:T,fixed:L,"background-color":C,"branch-color":B,"text-color":N,"font-size":E,"font-style":I,"font-weight":P},r=s[e];return void 0===r?c('"'+e+'" is not a valid node property'):void(r.call(o,n,t)!==!1&&ee.call("nodeupdate",o,Y.selected,n,e))}function X(e,t){const n=new Image;n.src=p(),n.onload=function(){const o=document.createElement("canvas"),s=o.getContext("2d"),r=document.createElement("a");o.width=n.width,o.height=n.height,s.drawImage(n,0,0),s.globalCompositeOperation="destination-over",s.fillStyle=t||"#ffffff",s.fillRect(0,0,o.width,o.height),r.download=e,r.href=o.toDataURL("image/png"),r.click()}}function G(){Y.counter=0,Y.nodes.clear(),x(),z(),q(),b(),ee.call("mmcreate"),f()}function J(){const e=Y.history;e.index>0&&k(e.snapshots[--e.index])}function K(){const e=Y.history;e.index<e.snapshots.length-1&&k(e.snapshots[++e.index])}function Q(){return Y.history.snapshots[Y.history.index]}function W(e){k(e),q(),b()}const Y={},Z=t.zoom().scaleExtent([.5,2]).on("zoom",o),$=t.drag().on("drag",l).on("start",function(e){d(e.key)}).on("end",function(){Y.dragged&&(Y.dragged=!1,b())}),ee=t.dispatch("mmcreate","mmcenter","nodefocus","nodeselect","nodeupdate","nodecreate","noderemove");e.mmap={init:n,center:q,undo:J,repeat:K,new:G,events:ee,png:X,data:Q,load:W,node:{update:F,remove:_,add:D}}}(this,window.d3);