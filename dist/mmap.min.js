!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.mmap=e.mmap||{})}(this,function(e){"use strict";function t(e){Y.container=d3.select(e),Y.history={index:-1,snapshots:[]},Y.svg={},Y.svg.main=Y.container.append("svg").attr("width","100%").attr("height","100%").call(Z),Y.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",f),Y.svg.mmap=Y.svg.main.append("g"),Y.nodes=d3.map(),Y.counter=0,g(),z(),w(),S(),ee.call("mmcreate"),window.onresize=D,f()}function n(){Y.svg.mmap.attr("transform",d3.event.transform)}function o(e,t){var n;if(e.x>t.x)n=1;else if(e.x<t.x)n=-1;else{const e=e=>"node0"===e.parent,t=Y.nodes.values().filter(e).length;n=t%2===0?-1:1}return e.x+200*n}function s(e){return e<Y.nodes.get("node0").x}function r(e){return console.error(e),!1}function c(e,t,n){e.setAttribute("transform","translate("+[t,n]+")")}function i(e){const t=d3.event.dy,n=d3.event.dx,o=e.value.x+=n,r=e.value.y+=t,i=e,a=s(o)===s(o-n);c(this,o,r),e.value.fixed&&l(e.key,function(e,o){const s=e.x+=n,r=e.y+=t;a||(e.x+=2*(i.value.x-e.x)),c(this,s,r)}),d3.selectAll(".branch").attr("d",L),Y.dragged=!0}function l(e,t){Y.nodes.each(function(n,o){n.parent===e&&(t.call(document.getElementById(o),n,o),l(o,t))})}function a(e){if(Y.selected!==e||"node0"===Y.selected){d3.selectAll(".node > path").style("stroke","none"),Y.selected=e;const t=d3.select("#"+e),n=t.select("path");n.style("stroke",d3.color(n.style("fill")).darker(.5)),ee.call("nodeselect",t.node(),e,Y.nodes.get(e))}}function d(){const e=d3.select("#"+Y.selected),t=e.select("path");t.style("stroke",d3.color(t.style("fill")).darker(.5)),e.node().dispatchEvent(new MouseEvent("dblclick"))}function f(){a("node0"),d3.select("#node0 > path").style("stroke","none")}function u(e){for(var t=e.parent,n=0;t;){n++;const e=Y.nodes.get(t);t=e.parent}return n}function h(e){return Object.assign({},e)}function m(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const r=n[o].cssRules;for(var s=0;s<r.length;s++){const n=r[s],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function y(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function p(){const e=Y.svg.mmap.node(),t=document.createElementNS("http://www.w3.org/2000/svg","svg"),n="http://www.w3.org/2000/xmlns/",o=e.getBBox(),s=15,r=o.x-s,c=o.y-s,i=o.width+30,l=o.height+30;t.setAttributeNS(n,"xmlns","http://www.w3.org/2000/svg"),t.setAttributeNS(n,"xmlns:xlink","http://www.w3.org/1999/xlink"),t.setAttribute("version","1.1"),t.setAttribute("width",i),t.setAttribute("height",l),t.setAttribute("viewBox",[r,c,i,l].join(" "));const a=m(e),d=document.createElement("style"),f=document.createElement("defs");d.setAttribute("type","text/css"),d.innerHTML="<![CDATA[\n"+a+"\n]]>",f.appendChild(d),t.appendChild(f);const u=e.cloneNode(!0);u.setAttribute("transform","translate(0,0)"),t.appendChild(u);const h=window.btoa(y(t.outerHTML));return"data:image/svg+xml;base64,"+h}function g(){Y.nodes.set("node"+Y.counter,{name:"Root node",fixed:!1,x:parseInt(Y.container.style("width"))/2,y:parseInt(Y.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function x(){const e=e=>parseInt(e.substring(4)),t=Y.nodes.keys().map(e);Y.counter=Math.max(...t)}function v(){return Y.nodes.entries().map(function(e){return{key:e.key,value:h(e.value)}})}function w(){const e=Y.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1),e.snapshots.push(v()),e.index++}function b(e){Y.nodes.clear(),e.forEach(function(e){Y.nodes.set(e.key,h(e.value))}),k(),f(),x()}function k(){d3.selectAll(".node, .branch").remove(),z()}function z(){const e=Y.nodes.entries(),t=Y.svg.mmap.selectAll(".node").data(e),n=Y.svg.mmap.selectAll(".branch").data(e.slice(1)),o=t.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.value.x+","+e.value.y+")").call($).on("dblclick",function(e){ee.call("nodefocus",this,e.key,e.value),d3.event.stopPropagation()});o.append("text").text(e=>e.value.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",e=>e.value["text-color"]).style("font-size",e=>e.value["font-size"]).style("font-style",e=>e.value["font-style"]).style("font-weight",e=>e.value["font-weight"]),o.insert("path","text").style("fill",e=>e.value["background-color"]).style("stroke-width",3).attr("d",M),n.enter().insert("path","g").style("fill",e=>e.value["branch-color"]).style("stroke",e=>e.value["branch-color"]).attr("class","branch").attr("id",e=>"branchOf"+e.key).attr("d",L),t.exit().remove(),n.exit().remove()}function A(e,t){if(e.name==t)return!1;{const n=this.childNodes[1],o=this.childNodes[0];e.name=n.innerHTML=t,e.width=n.textLength.baseVal.value+45,d3.select(o).attr("d",M),w()}}function T(e,t){if(e["background-color"]===t)return!1;{const n=this.childNodes[0];n.style.setProperty("fill",e["background-color"]=t),n.style.setProperty("stroke",d3.color(t).darker(.5)),w()}}function C(e,t){if(e["text-color"]===t)return!1;{const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t),w()}}function N(e,t){if(e["font-size"]==t)return!1;{const n=this.childNodes[1],o=this.childNodes[0];n.style.setProperty("font-size",e["font-size"]=t),e.width=n.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,d3.select(o).attr("d",M),d3.selectAll(".branch").attr("d",L),w()}}function E(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"]),w()}function I(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"]),w()}function P(e,t){if("node0"===Y.selected)return r("The root node has no branches");if(e["branch-color"]===t)return!1;{const n=document.getElementById("branchOf"+Y.selected);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t),w()}}function B(e){return"node0"===Y.selected?r("The root node can not be fixed"):(e.fixed=!e.fixed,void w())}function L(e){const t=e.value,n=Y.nodes.get(t.parent),o=u(t),s=22-3*(o<5?o:5),r=(n.x+t.x)/2,c=n.y<t.y+t.height/2?-1:1,i=n.x>t.x?-1:1,l=i*c,a=d3.path();return a.moveTo(n.x,n.y-.8*s),a.bezierCurveTo(r-s*l,n.y-s/2,n.x-s/2*l,t.y+t.height/2-s/3,t.x-t.width/3*i,t.y+t.height/2+3),a.bezierCurveTo(n.x+s/2*l,t.y+t.height/2+s/3,r+s*l,n.y+s/2,n.x,n.y+.8*s),a.closePath(),a}function M(e){const t=e.value,n=d3.path(),o=(t.width=this.nextSibling.getBBox().width+45)/2,s=(t.height=11*t["font-size"]/10+30)/2,r=t.k=t.k||d3.randomUniform(-20,20)();return n.moveTo(-o,r/3),n.bezierCurveTo(-o,-s+10,-o+10,-s,r,-s),n.bezierCurveTo(o-10,-s,o,-s+10,o,r/3),n.bezierCurveTo(o,s-10,o-10,s,r,s),n.bezierCurveTo(-o+10,s,-o,s-10,-o,r/3),n.closePath(),n}function S(e,t){const n={},o=function(){return U(arguments,n)};onkeyup=onkeydown=function(e){if(n[e.keyCode]="keydown"===e.type,o("ctrl","maiusc","z"))return!!J();if(o("ctrl","z"))return!!G();if(o("ctrl","maiusc","up"))V("up");else if(o("ctrl","maiusc","down"))V("down");else if(o("ctrl","maiusc","left"))V("left");else if(o("ctrl","maiusc","right"))V("right");else{if(o("alt","up"))return!!j("up");if(o("alt","down"))return!!j("down");if(o("alt","right"))return!!j("right");if(o("alt","left"))return!!j("left");if(o("alt","i"))F("mmap");else if(o("alt","c"))D();else if(o("alt","n"))X();else if(o("alt","+"))_();else if(o("alt","-"))H();else{if(o("alt","f"))return!!d();o("esc")&&f()}}}}function U(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,f:70,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function R(e){const t=Y.nodes.get(Y.selected),n=u(t),o=s(t.x);var r,c=Number.MAX_VALUE;Y.nodes.each(function(i,l){const a=e?t.y-i.y:i.y-t.y,d=n===u(i),f=Y.selected===l,h=o===s(i.x);h&&d&&!f&&a>0&&a<c&&(c=a,r=l)}),void 0!==r&&a(r)}function O(e){const t=Y.nodes.get(Y.selected),n=Y.nodes.get("node0");var o,s,r=Number.MIN_VALUE;Y.nodes.each(function(c,i){s=t.x<n.x?e?c.parent===Y.selected:t.parent===i:t.x>n.x?e?t.parent===i:c.parent===Y.selected:(e?c.x<n.x:c.x>n.x)&&c.parent===Y.selected,s&&c.y>r&&(r=c.y,o=i)}),void 0!==o&&a(o)}function j(e){const t="up"===e||"left"===e;"up"===e||"down"===e?R(t):O(t)}function V(e){const t=Y.nodes.get(Y.selected),n=10,o=s(t.x),r={up:e=>e.y-=n,down:e=>e.y+=n,right:e=>e.x+=n,left:e=>e.x-=n};r[e](t);const i=s(t.x);c(document.getElementById(Y.selected),t.x,t.y),t.fixed&&l(Y.selected,function(n,s){r[e](n),i!==o&&(n.x+=2*(t.x-n.x)),c(this,n.x,n.y)}),d3.selectAll(".branch").attr("d",L),w()}function _(e){const t=Y.nodes.get(Y.selected),n=Y.nodes.get("node0"),s="node"+ ++Y.counter,r={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f9f9f9","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||t["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",fixed:e&&e.fixed||!0,x:e&&e.x||o(t,n),y:e&&e.y||t.y-d3.randomUniform(60,100)(),parent:Y.selected};Y.nodes.set(s,r),z(),ee.call("nodecreate"),w()}function H(){const e=Y.selected;return"node0"===e?r("The root node can not be deleted"):(Y.nodes.remove(e),l(e,function(e,t){Y.nodes.remove(t)}),a("node0"),k(),w(),ee.call("noderemove",this,e),void 0)}function D(){const e=Y.nodes.get("node0"),t={x:parseInt(Y.container.style("width"))/2,y:parseInt(Y.container.style("height"))/2},n=d3.zoomIdentity.translate(t.x-e.x,t.y-e.y);Y.svg.main.transition().duration(500).call(Z.transform,n),ee.call("mmcenter")}function q(e,t){const n=Y.nodes.get(Y.selected),o=document.getElementById(Y.selected),s={name:A,fixed:B,"background-color":T,"branch-color":P,"text-color":C,"font-size":N,"font-style":E,"font-weight":I},c=s[e];return void 0===c?r('"'+e+'" is not a valid node property'):void(c.call(o,n,t)!==!1&&ee.call("nodeupdate",o,Y.selected,n,e))}function F(e,t){const n=new Image;n.src=p(),n.onload=function(){const o=document.createElement("canvas"),s=o.getContext("2d"),r=document.createElement("a");o.width=n.width,o.height=n.height,s.drawImage(n,0,0),s.globalCompositeOperation="destination-over",s.fillStyle=t||"#ffffff",s.fillRect(0,0,o.width,o.height),r.download=e,r.href=o.toDataURL("image/png"),r.click()}}function X(){Y.counter=0,Y.nodes.clear(),g(),k(),D(),w(),ee.call("mmcreate"),f()}function G(){const e=Y.history;e.index>0&&b(e.snapshots[--e.index])}function J(){const e=Y.history;e.index<e.snapshots.length-1&&b(e.snapshots[++e.index])}function K(){return Y.history.snapshots[Y.history.index]}function Q(e){b(e),D(),w()}const W="0.1.1",Y={},Z=d3.zoom().scaleExtent([.5,2]).on("zoom",n),$=d3.drag().on("drag",i).on("start",function(e){a(e.key)}).on("end",function(){Y.dragged&&(Y.dragged=!1,w())}),ee=d3.dispatch("mmcreate","mmcenter","nodefocus","nodeselect","nodeupdate","nodecreate","noderemove");e.version=W,e.init=t,e.center=D,e.undo=G,e.repeat=J,e.new=X,e.events=ee,e.png=F,e.data=K,e.load=Q,e.node={update:q,remove:H,add:_},Object.defineProperty(e,"__esModule",{value:!0})});