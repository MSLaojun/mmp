!function(e,t){function n(n){V.container=t.select(n),V.svg={},V.svg.main=V.container.append("svg").attr("width","100%").attr("height","100%").call(H),V.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",s),V.svg.mmap=V.svg.main.append("g"),V.nodes=t.map(),V.counter=0,h(),y(),s(),z(),e.onresize=B,D.call("mmcreate")}function o(){V.svg.mmap.attr("transform",t.event.transform)}function r(e){const n=e.x=t.event.x,o=e.y=t.event.y;t.select(this).attr("transform","translate("+n+","+o+")"),t.selectAll(".branch").attr("d",b)}function c(e){if(V.selected!==e||"node0"===V.selected){t.selectAll(".node > path").style("stroke","none"),V.selected=e;const n=t.select("#"+e),o=n.select("path");o.style("stroke",t.color(o.style("fill")).darker(.5)),D.call("nodeselect",n.node(),V.nodes.get(e))}}function s(){c("node0"),t.select("#node0 > path").style("stroke","none")}function l(e){for(var t=e.parent,n=0;t;)n++,t=t.parent;return n}function a(){const e=[];return V.nodes.each(function(t,n){t.key=n,e.push(t)}),e}function i(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const c=n[o].cssRules;for(var r=0;r<c.length;r++){const n=c[r],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function d(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function f(){const t=V.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=t.getBBox(),r=15,c=o.x-r,s=o.y-r,l=o.width+30,a=o.height+30,f="http://www.w3.org/2000/xmlns/";n.setAttributeNS(f,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(f,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",l),n.setAttribute("height",a),n.setAttribute("viewBox",[c,s,l,a].join(" "));const h=i(t),u=document.createElement("style"),y=document.createElement("defs");u.setAttribute("type","text/css"),u.innerHTML="<![CDATA[\n"+h+"\n]]>",y.appendChild(u),n.appendChild(y);const g=t.cloneNode(!0);g.setAttribute("transform","translate(0,0)"),n.appendChild(g);const m=e.btoa(d(n.outerHTML));return"data:image/svg+xml;base64,"+m}function h(){V.nodes.set("node"+V.counter,{name:"Root node",x:parseInt(V.container.style("width"))/2,y:parseInt(V.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function u(){t.selectAll(".node, .branch").remove(),y()}function y(){const e=a(),n=V.svg.mmap.selectAll(".node").data(e),o=n.enter().append("g").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.x+","+e.y+")").call(O).on("dblclick",function(e){D.call("nodedblclick",this,e),t.event.stopPropagation()});o.append("text").text(e=>e.name).attr("fill",e=>e["text-color"]).attr("font-size",e=>e["font-size"]).attr("font-style",e=>e["font-style"]).attr("font-weight",e=>e["font-weight"]),o.insert("path","text").style("fill",e=>e["background-color"]).attr("d",A),n.exit().remove();const r=V.svg.mmap.selectAll(".branch").data(e.slice(1));r.enter().insert("path","g").attr("class","branch").attr("id",e=>"branchOf"+e.key).style("fill",e=>e["branch-color"]).style("stroke",e=>e["branch-color"]).attr("d",b),r.exit().remove()}function g(e,n){const o=this.childNodes[1],r=this.childNodes[0];e.name=o.innerHTML=n,e.width=o.textLength.baseVal.value+45,t.select(r).attr("d",A)}function m(e,n){const o=this.childNodes[0];o.style.setProperty("fill",e["background-color"]=n),o.style.setProperty("stroke",t.color(n).darker(.5))}function p(e,t){const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t)}function x(e,n){const o=this.childNodes[1],r=this.childNodes[0];o.style.setProperty("font-size",e["font-size"]=n),e.width=o.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,t.select(r).attr("d",A),t.selectAll(".branch").attr("d",b)}function w(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"])}function v(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"])}function k(e,t){if("node0"!==e.key){const n=document.getElementById("branchOf"+e.key);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t)}else console.warn("The root node has no branches")}function b(e){const n=l(e),o=22-3*(n<5?n:5),r=(e.parent.x+e.x)/2,c=e.parent.y<e.y+e.height/2?-1:1,s=e.parent.x>e.x?-1:1,a=s*c,i=t.path();return i.moveTo(e.parent.x,e.parent.y-.8*o),i.bezierCurveTo(r-o*a,e.parent.y-o/2,e.parent.x-o/2*a,e.y+e.height/2-o/3,e.x-e.width/3*s,e.y+e.height/2+3),i.bezierCurveTo(e.parent.x+o/2*a,e.y+e.height/2+o/3,r+o*a,e.parent.y+o/2,e.parent.x,e.parent.y+.8*o),i.closePath(),i}function A(e){const n=t.path(),o=(e.width=this.nextSibling.getBBox().width+45)/2,r=(e.height=11*e["font-size"]/10+30)/2,c=e.k=e.k||t.randomUniform(-20,20)();return n.moveTo(-o,c/3),n.bezierCurveTo(-o,-r+10,-o+10,-r,c,-r),n.bezierCurveTo(o-10,-r,o,-r+10,o,c/3),n.bezierCurveTo(o,r-10,o-10,r,c,r),n.bezierCurveTo(-o+10,r,-o,r-10,-o,c/3),n.closePath(),n}function z(e,t){var n={},o=function(){return N(arguments,n)};onkeyup=onkeydown=function(e){n[e.keyCode]="keydown"===e.type,o("ctrl","up")?P("up"):o("ctrl","down")?P("down"):o("ctrl","left")?P("left"):o("ctrl","right")?P("right"):o("up")?I("up"):o("down")?I("down"):o("right")?I("right"):o("left")?I("left"):o("c")?B():o("n")?U():o("+")?L():o("-")?S():o("enter")?C():o("esc")&&s()}}function N(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,enter:13,c:67,n:78,"+":187,"-":189};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function C(){const e=t.select("#"+V.selected),n=e.select("path");n.style("stroke",t.color(n.style("fill")).darker(.5));const o=new MouseEvent("dblclick");e.node().dispatchEvent(o)}function T(e,t){const n=V.nodes.get("node0"),o=l(e),r=n.x>e.x;var c,s=Number.MAX_VALUE;return V.nodes.each(function(a,i){const d=t?e.y-a.y:a.y-e.y,f=o===l(a),h=e.key===a.key,u=r&&n.x>a.x||!r&&n.x<a.x;u&&f&&!h&&d>0&&d<s&&(s=d,c=a.key)}),c||e.key}function E(e,t){const n=V.nodes.get("node0"),o=l(e);var r,c,s,a=Number.MIN_VALUE;return s=e.x<n.x?o+(t?1:-1):e.x>n.x?o+(t?-1:1):o+1,V.nodes.each(function(o,i){e.x<n.x?(c=(o.x<n.x||"node0"===o.key)&&(!t||o.parent===e.key),console.log(o.parent,e.key)):c=e.x>n.x?o.x>n.x||"node0"===o.key:t?o.x<n.x:o.x>n.x,c&&l(o)===s&&o.y>a&&(a=o.y,r=o.key)}),r||e.key}function I(e){const t=V.nodes.get(V.selected);c({up:T,down:T,left:E,right:E}[e](t,"up"===e||"left"===e))}function P(e){const n=V.nodes.get(V.selected),o=t.select("#"+V.selected),r=10;switch(e){case"up":n.y-=r;break;case"down":n.y+=r;break;case"right":n.x+=r;break;case"left":n.x-=r}o.attr("transform",e=>"translate("+e.x+","+e.y+")"),t.selectAll(".branch").attr("d",b)}function L(e){if(V.selected){const t=V.nodes.get(V.selected),n=V.nodes.get("node0"),o="node"+ ++V.counter,r={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f1f1f1","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",x:t.x+(t.x>n.x?200:-200),y:t.y+50,parent:t};V.nodes.set(o,r),y(),D.call("nodecreate")}}function S(){if("node0"!==V.selected){V.nodes.remove(V.selected);const e=function(t){V.nodes.each(function(n){if("node0"!==n.key&&n.parent.key===t)return V.nodes.remove(n.key),void e(n.key)})};e(V.selected),c("node0"),u(),D.call("noderemove")}else console.warn("The root node can not be deleted")}function B(){const e=V.nodes.get("node0"),n={x:parseInt(V.container.style("width"))/2,y:parseInt(V.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);V.svg.main.transition().duration(500).call(H.transform,o),D.call("mmcenter")}function M(e,t){const n=V.nodes.get(V.selected),o=document.getElementById(n.key),r={name:g,"background-color":m,"branch-color":k,"text-color":p,"font-size":x,"font-style":w,"font-weight":v,default:function(){console.error('"'+e+'" is not a valid node property')}};(r[e]||r.default).call(o,n,t)}function R(e,t){const n=new Image;n.src=f(),n.onload=function(){const o=document.createElement("canvas"),r=o.getContext("2d"),c=document.createElement("a");o.width=n.width,o.height=n.height,r.drawImage(n,0,0),r.globalCompositeOperation="destination-over",r.fillStyle=t||"#ffffff",r.fillRect(0,0,o.width,o.height),c.download=e,c.href=o.toDataURL("image/png"),c.click()}}function U(){V.counter=0,V.nodes.clear(),h(),u(),s(),B()}const V={},H=t.zoom().scaleExtent([.5,2]).on("zoom",o),O=t.drag().on("drag",r).on("start",function(e){c(e.key)}),D=t.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");e.mmap={init:n,center:B,newMap:U,addNode:L,removeNode:S,updateNode:M,events:D,getPNG:R}}(this,window.d3);