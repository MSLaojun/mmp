!function(e,t){function n(n){E.container=t.select(n),E.svg={},E.svg.main=E.container.append("svg").attr("width","100%").attr("height","100%").attr("id","mmap").append("g").call(B),E.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",i),E.svg.mmap=E.svg.main.append("g"),E.nodes=t.map(),E.counter=0,E.nodes.set("node"+E.counter,{name:"Root node",x:parseInt(E.container.style("width"))/2,y:parseInt(E.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"}),d(),i(),e.onresize=k,R.call("mmcreate")}function o(){E.svg.mmap.attr("transform",t.event.transform)}function r(e){const n=e.x=t.event.x,o=e.y=t.event.y;t.select(this).attr("transform","translate("+n+","+o+")"),t.selectAll(".branch").attr("d",v)}function a(e){if(E.selected!==e||"node0"===E.selected){t.selectAll(".node > path").style("stroke","none"),E.selected=e;const n=t.select("#"+e),o=n.select("path");o.style("stroke",t.color(o.style("fill")).darker(.5)),R.call("nodeselect",n.node(),E.nodes.get(e))}}function i(){a("node0"),t.select("#node0 > path").style("stroke","none")}function s(e){for(var t=e.parent,n=0;t;)n++,t=t.parent;return n<5?n:5}function c(){const e=[];return E.nodes.each(function(t,n){t.key=n,e.push(t)}),e}function l(){t.selectAll(".node, .branch").remove(),d()}function d(){const e=c(),n=E.svg.mmap.selectAll(".node").data(e),o=n.enter().append("g").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.x+","+e.y+")").call(P).on("dblclick",function(e){R.call("nodedblclick",this,e),t.event.stopPropagation()});o.append("text").text(e=>e.name).attr("fill",e=>e["text-color"]).attr("font-size",e=>e["font-size"]).attr("font-style",e=>e["font-style"]).attr("font-weight",e=>e["font-weight"]),o.insert("path","text").style("fill",e=>e["background-color"]).attr("d",w),n.exit().remove();const r=E.svg.mmap.selectAll(".branch").data(e.slice(1));r.enter().insert("path","g").attr("class","branch").attr("id",e=>"branchOf"+e.key).style("fill",e=>e["branch-color"]).style("stroke",e=>e["branch-color"]).attr("d",v),r.exit().remove()}function h(e,n){const o=this.childNodes[1],r=this.childNodes[0];e.name=o.innerHTML=n,e.width=o.textLength.baseVal.value+45,t.select(r).attr("d",w)}function f(e,n){const o=this.childNodes[0];o.style.setProperty("fill",e["background-color"]=n),o.style.setProperty("stroke",t.color(n).darker(.5))}function u(e,t){const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t)}function m(e,n){const o=this.childNodes[1],r=this.childNodes[0];o.style.setProperty("font-size",e["font-size"]=n),e.width=o.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,t.select(r).attr("d",w),t.selectAll(".branch").attr("d",v)}function g(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"])}function p(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"])}function y(e,t){if("node0"!==e.key){const n=document.getElementById("branchOf"+e.key);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t)}else console.warn("The root node has no branches")}function v(e){const n=22-3*s(e),o=(e.parent.x+e.x)/2,r=e.parent.y<e.y+e.height/2?-1:1,a=e.parent.x>e.x?-1:1,i=a*r,c=t.path();return c.moveTo(e.parent.x,e.parent.y-.8*n),c.bezierCurveTo(o-n*i,e.parent.y-n/2,e.parent.x-n/2*i,e.y+e.height/2-n/3,e.x-e.width/3*a,e.y+e.height/2+3),c.bezierCurveTo(e.parent.x+n/2*i,e.y+e.height/2+n/3,o+n*i,e.parent.y+n/2,e.parent.x,e.parent.y+.8*n),c.closePath(),c}function w(e){const n=t.path(),o=(e.width=this.nextSibling.getBBox().width+45)/2,r=(e.height=11*e["font-size"]/10+30)/2,a=e.k=e.k||t.randomUniform(-20,20)();return n.moveTo(-o,a/3),n.bezierCurveTo(-o,-r+10,-o+10,-r,a,-r),n.bezierCurveTo(o-10,-r,o,-r+10,o,a/3),n.bezierCurveTo(o,r-10,o-10,r,a,r),n.bezierCurveTo(-o+10,r,-o,r-10,-o,a/3),n.closePath(),n}function x(e){if(E.selected){const t=E.nodes.get(E.selected),n=E.nodes.get("node0"),o="node"+ ++E.counter,r={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f1f1f1","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",x:t.x+(t.x>n.x?200:-200),y:t.y+50,parent:t};E.nodes.set(o,r),d(),R.call("nodecreate")}}function b(){if("node0"!==E.selected){E.nodes.remove(E.selected);const e=function(t){E.nodes.each(function(n){if("node0"!==n.key&&n.parent.key===t)return E.nodes.remove(n.key),void e(n.key)})};e(E.selected),a("node0"),l(),R.call("noderemove")}else console.warn("The root node can not be deleted")}function k(){const e=E.nodes.get("node0"),n={x:parseInt(E.container.style("width"))/2,y:parseInt(E.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);E.svg.main.transition().duration(500).call(B.transform,o),R.call("mmcenter")}function A(e,t){const n=E.nodes.get(E.selected),o=document.getElementById(n.key),r={name:h,"background-color":f,"branch-color":y,"text-color":u,"font-size":m,"font-style":g,"font-weight":p,default:function(){console.error('"'+e+'" is not a valid node property')}};(r[e]||r.default).call(o,n,t)}function C(e){N(document.getElementById("mmap"),{},function(t){var n=new Image;n.onload=function(){var t=document.createElement("canvas");t.width=n.width,t.height=n.height;var o=t.getContext("2d");o.drawImage(n,0,0);var r;document.createElement("a");try{r=t.toDataURL("image/png")}catch(e){if("undefined"!=typeof SecurityError&&e instanceof SecurityError||"SecurityError"==e.name)return void console.error("Rendered SVG images cannot be downloaded in this browser.");throw e}const a=document.createElement("a");a.download=e,a.href=r,document.body.appendChild(a),a.onclick=function(e){a.parentNode.removeChild(a)},a.click()},n.onerror=function(e){console.error("There was an error loading the data URI as an image",e)},n.src=t})}function N(t,n,o){n=n||{},n.scale=n.scale||1,n.responsive=n.responsive||!1;var r="http://www.w3.org/2000/xmlns/";S(t,function(){var a,i,s=document.createElement("div"),c=t.cloneNode(!0);if("svg"==t.tagName)a=n.width||T(t,c,"width"),i=n.height||T(t,c,"height");else{if(!t.getBBox)return void console.error("Attempted to render non-SVG element",t);var l=t.getBBox();a=l.x+l.width,i=l.y+l.height,c.setAttribute("transform",c.getAttribute("transform").replace(/translate\(.*?\)/,""));var d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.appendChild(c),c=d}c.setAttribute("version","1.1"),c.getAttribute("xmlns")||c.setAttributeNS(r,"xmlns","http://www.w3.org/2000/svg"),c.getAttribute("xmlns:xlink")||c.setAttributeNS(r,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.responsive?(c.removeAttribute("width"),c.removeAttribute("height"),c.setAttribute("preserveAspectRatio","xMinYMin meet")):(c.setAttribute("width",a*n.scale),c.setAttribute("height",i*n.scale)),c.setAttribute("viewBox",[n.left||0,n.top||0,a,i].join(" "));for(var h=c.querySelectorAll("foreignObject > *"),f=0;f<h.length;f++)h[f].setAttributeNS(r,"xmlns","http://www.w3.org/1999/xhtml");s.appendChild(c);var u=z(t,n.selectorRemap),m=document.createElement("style");m.setAttribute("type","text/css"),m.innerHTML="<![CDATA[\n"+u+"\n]]>";var g=document.createElement("defs");g.appendChild(m),c.insertBefore(g,c.firstChild);var p='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">',d=p+s.innerHTML,y="data:image/svg+xml;base64,"+e.btoa(I(d));o&&o(y)})}function S(e,t){var n=e.querySelectorAll("image"),o=n.length,r=function(){0===o&&t()};r();for(var a=0;a<n.length;a++)!function(e){var t=e.getAttributeNS("http://www.w3.org/1999/xlink","href");if(t&&isExternal(t.value))return void console.warn("Cannot render embedded images linking to external hosts: "+t.value);var n=document.createElement("canvas"),a=n.getContext("2d"),i=new Image;t=t||e.getAttribute("href"),t?(i.src=t,i.onload=function(){n.width=i.width,n.height=i.height,a.drawImage(i,0,0),e.setAttributeNS("http://www.w3.org/1999/xlink","href",n.toDataURL("image/png")),o--,r()},i.onerror=function(){console.log("Could not load "+t),o--,r()}):(o--,r())}(n[a])}function T(t,n,o){var r=t.viewBox&&t.viewBox.baseVal&&t.viewBox.baseVal[o]||null!==n.getAttribute(o)&&!n.getAttribute(o).match(/%$/)&&parseInt(n.getAttribute(o))||t.getBoundingClientRect()[o]||parseInt(n.style[o])||parseInt(e.getComputedStyle(t).getPropertyValue(o));return"undefined"==typeof r||null===r||isNaN(parseFloat(r))?0:r}function z(e,t){for(var n="",o=document.styleSheets,r=0;r<o.length;r++){try{var a=o[r].cssRules}catch(e){console.warn("Stylesheet could not be loaded: "+o[r].href);continue}if(null!=a)for(var i=0;i<a.length;i++){var s=a[i];if("undefined"!=typeof s.style){var c,l;try{l=s.selectorText}catch(e){console.warn('The following CSS rule has an invalid selector: "'+s+'"',e)}try{l&&(c=e.querySelector(l))}catch(e){console.warn('Invalid CSS selector "'+l+'"',e)}if(c){var d=t?t(s.selectorText):s.selectorText;n+=d+" { "+s.style.cssText+" }\n"}else s.cssText.match(/^@font-face/)&&(n+=s.cssText+"\n")}}}return n}function I(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){var n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}const E={},B=t.zoom().scaleExtent([.5,2]).on("zoom",o),P=t.drag().on("drag",r).on("start",function(e){a(e.key)}),R=t.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");e.mmap={init:n,center:k,addNode:x,removeNode:b,updateNode:A,events:R,getPNG:C}}(this,window.d3);