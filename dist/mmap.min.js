!function(t,e){function n(n){S.container=e.select(n),S.svg={},S.svg.main=S.container.append("svg").attr("width","100%").attr("height","100%").call(B),S.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",s),S.svg.mmap=S.svg.main.append("g"),S.nodes=e.map(),S.counter=0,h(),g(),s(),u(),t.onresize=T,R.call("mmcreate")}function o(){S.svg.mmap.attr("transform",e.event.transform)}function r(t){const n=t.x=e.event.x,o=t.y=e.event.y;e.select(this).attr("transform","translate("+n+","+o+")"),e.selectAll(".branch").attr("d",z)}function c(t){if(S.selected!==t||"node0"===S.selected){e.selectAll(".node > path").style("stroke","none"),S.selected=t;const n=e.select("#"+t),o=n.select("path");o.style("stroke",e.color(o.style("fill")).darker(.5)),R.call("nodeselect",n.node(),S.nodes.get(t))}}function s(){c("node0"),e.select("#node0 > path").style("stroke","none")}function l(t){for(var e=t.parent,n=0;e;)n++,e=e.parent;return n<5?n:5}function i(){const t=[];return S.nodes.each(function(e,n){e.key=n,t.push(e)}),t}function a(t){var e="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const c=n[o].cssRules;for(var r=0;r<c.length;r++){const n=c[r],o=n.cssText.match(/^@font-face/);(t.querySelector(n.selectorText)||o)&&(e+=n.cssText)}}return e}function d(t){return t=encodeURIComponent(t),t=t.replace(/%([0-9A-F]{2})/g,function(t,e){const n=String.fromCharCode("0x"+e);return"%"===n?"%25":n}),decodeURIComponent(t)}function f(){const e=S.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=e.getBBox(),r=15,c=o.x-r,s=o.y-r,l=o.width+30,i=o.height+30,f="http://www.w3.org/2000/xmlns/";n.setAttributeNS(f,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(f,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",l),n.setAttribute("height",i),n.setAttribute("viewBox",[c,s,l,i].join(" "));const h=a(e),u=document.createElement("style"),m=document.createElement("defs");u.setAttribute("type","text/css"),u.innerHTML="<![CDATA[\n"+h+"\n]]>",m.appendChild(u),n.appendChild(m);const g=e.cloneNode(!0);g.setAttribute("transform","translate(0,0)"),n.appendChild(g);const y=t.btoa(d(n.outerHTML));return"data:image/svg+xml;base64,"+y}function h(){S.nodes.set("node"+S.counter,{name:"Root node",x:parseInt(S.container.style("width"))/2,y:parseInt(S.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function u(){var t={},e=function(e){return e(),t={},!1};onkeyup=onkeydown=function(n){return t[n.keyCode]="keydown"===n.type,t[17]&&t[38]?e(function(){console.log("ctrl+up")}):t[17]&&t[40]?e(function(){console.log("ctrl+down")}):t[17]&&t[39]?e(function(){console.log("ctrl+right")}):t[17]&&t[37]?e(function(){console.log("ctrl+left")}):void 0}}function m(){e.selectAll(".node, .branch").remove(),g()}function g(){const t=i(),n=S.svg.mmap.selectAll(".node").data(t),o=n.enter().append("g").attr("class","node").attr("id",t=>t.key).attr("transform",t=>"translate("+t.x+","+t.y+")").call(L).on("dblclick",function(t){R.call("nodedblclick",this,t),e.event.stopPropagation()});o.append("text").text(t=>t.name).attr("fill",t=>t["text-color"]).attr("font-size",t=>t["font-size"]).attr("font-style",t=>t["font-style"]).attr("font-weight",t=>t["font-weight"]),o.insert("path","text").style("fill",t=>t["background-color"]).attr("d",A),n.exit().remove();const r=S.svg.mmap.selectAll(".branch").data(t.slice(1));r.enter().insert("path","g").attr("class","branch").attr("id",t=>"branchOf"+t.key).style("fill",t=>t["branch-color"]).style("stroke",t=>t["branch-color"]).attr("d",z),r.exit().remove()}function y(t,n){const o=this.childNodes[1],r=this.childNodes[0];t.name=o.innerHTML=n,t.width=o.textLength.baseVal.value+45,e.select(r).attr("d",A)}function p(t,n){const o=this.childNodes[0];o.style.setProperty("fill",t["background-color"]=n),o.style.setProperty("stroke",e.color(n).darker(.5))}function w(t,e){const n=this.childNodes[1];n.style.setProperty("fill",t["text-color"]=e)}function v(t,n){const o=this.childNodes[1],r=this.childNodes[0];o.style.setProperty("font-size",t["font-size"]=n),t.width=o.textLength.baseVal.value+45,t.height=11*t["font-size"]/10+30,e.select(r).attr("d",A),e.selectAll(".branch").attr("d",z)}function x(t){const e=this.childNodes[1];t["font-style"]="normal"===t["font-style"]?"italic":"normal",e.style.setProperty("font-style",t["font-style"])}function b(t){const e=this.childNodes[1];t["font-weight"]="normal"===t["font-weight"]?"bold":"normal",e.style.setProperty("font-weight",t["font-weight"])}function k(t,e){if("node0"!==t.key){const n=document.getElementById("branchOf"+t.key);n.style.setProperty("fill",t["branch-color"]=e),n.style.setProperty("stroke",t["branch-color"]=e)}else console.warn("The root node has no branches")}function z(t){const n=22-3*l(t),o=(t.parent.x+t.x)/2,r=t.parent.y<t.y+t.height/2?-1:1,c=t.parent.x>t.x?-1:1,s=c*r,i=e.path();return i.moveTo(t.parent.x,t.parent.y-.8*n),i.bezierCurveTo(o-n*s,t.parent.y-n/2,t.parent.x-n/2*s,t.y+t.height/2-n/3,t.x-t.width/3*c,t.y+t.height/2+3),i.bezierCurveTo(t.parent.x+n/2*s,t.y+t.height/2+n/3,o+n*s,t.parent.y+n/2,t.parent.x,t.parent.y+.8*n),i.closePath(),i}function A(t){const n=e.path(),o=(t.width=this.nextSibling.getBBox().width+45)/2,r=(t.height=11*t["font-size"]/10+30)/2,c=t.k=t.k||e.randomUniform(-20,20)();return n.moveTo(-o,c/3),n.bezierCurveTo(-o,-r+10,-o+10,-r,c,-r),n.bezierCurveTo(o-10,-r,o,-r+10,o,c/3),n.bezierCurveTo(o,r-10,o-10,r,c,r),n.bezierCurveTo(-o+10,r,-o,r-10,-o,c/3),n.closePath(),n}function C(t){if(S.selected){const e=S.nodes.get(S.selected),n=S.nodes.get("node0"),o="node"+ ++S.counter,r={name:t&&t.name||"Node","background-color":t&&t["background-color"]||"#f1f1f1","text-color":t&&t["text-color"]||"#808080","branch-color":t&&t["branch-color"]||"#9fad9c","font-size":t&&t["font-size"]||16,"font-style":t&&t["font-style"]||"normal","font-weight":t&&t["font-weight"]||"normal",x:e.x+(e.x>n.x?200:-200),y:e.y+50,parent:e};S.nodes.set(o,r),g(),R.call("nodecreate")}}function N(){if("node0"!==S.selected){S.nodes.remove(S.selected);const t=function(e){S.nodes.each(function(n){if("node0"!==n.key&&n.parent.key===e)return S.nodes.remove(n.key),void t(n.key)})};t(S.selected),c("node0"),m(),R.call("noderemove")}else console.warn("The root node can not be deleted")}function T(){const t=S.nodes.get("node0"),n={x:parseInt(S.container.style("width"))/2,y:parseInt(S.container.style("height"))/2},o=e.zoomIdentity.translate(n.x-t.x,n.y-t.y);S.svg.main.transition().duration(500).call(B.transform,o),R.call("mmcenter")}function P(t,e){const n=S.nodes.get(S.selected),o=document.getElementById(n.key),r={name:y,"background-color":p,"branch-color":k,"text-color":w,"font-size":v,"font-style":x,"font-weight":b,default:function(){console.error('"'+t+'" is not a valid node property')}};(r[t]||r.default).call(o,n,e)}function I(t,e){const n=new Image;n.src=f(),n.onload=function(){const o=document.createElement("canvas"),r=o.getContext("2d"),c=document.createElement("a");o.width=n.width,o.height=n.height,r.drawImage(n,0,0),r.globalCompositeOperation="destination-over",r.fillStyle=e||"#ffffff",r.fillRect(0,0,o.width,o.height),c.download=t,c.href=o.toDataURL("image/png"),c.click()}}function E(){S.counter=0,S.nodes.clear(),h(),m(),s(),T()}const S={},B=e.zoom().scaleExtent([.5,2]).on("zoom",o),L=e.drag().on("drag",r).on("start",function(t){c(t.key)}),R=e.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");t.mmap={init:n,center:T,newMap:E,addNode:C,removeNode:N,updateNode:P,events:R,getPNG:I}}(this,window.d3);