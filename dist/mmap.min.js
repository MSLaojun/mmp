!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],t):t(e.mmap=e.mmap||{},e.d3)}(this,function(e,t){"use strict";function n(){r(!0)}function o(){r(!1)}function r(e){var n=D.svg.main,o=t.zoomTransform(n.node()).k;o+=e?o/5:-o/5,F.scaleTo(n.transition().duration(100),o)}function i(e,t){G.on(e,t)}function a(e){return console.error(e),!1}function s(e){return Object.assign({},e)}function c(e){return e<D.nodes.get("node0").x}function l(e){return e?"italic":"normal"}function u(e){return e?"bold":"normal"}function d(e,t){for(var n in e){var o=e[n],r=t[n];r&&r.constructor===o.constructor&&(r.constructor===Object?d(o,r):e[n]=r)}}function f(e){var t=e.substring(0,1),n=e.substring(1);return"."===t?document.getElementsByClassName(n):"#"===t?document.getElementById(n):e.includes("node")?document.getElementById(e):document.getElementsByTagName(e)}function h(){var e=D.history;e.index>0&&y(e.snapshots[--e.index])}function v(){var e=D.history;e.index<e.snapshots.length-1&&y(e.snapshots[++e.index])}function m(){var e=D.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1),e.snapshots.push(g()),e.index++}function y(e){D.nodes.clear(),e.forEach(function(e){D.nodes.set(e.key,s(e.value))}),U(),p(),M()}function g(){return D.nodes.entries().map(function(e){var t=s(e.value);return delete t.width,delete t.height,{key:e.key,value:t}})}function p(){var e=function(e){return parseInt(e.substring(4))},t=D.nodes.keys().map(e);D.counter=Math.max.apply(Math,H(t))}function x(e){var n=e.value,o=D.nodes.get(n.parent),r=I(n),i=22-3*(r<5?r:5),a=(o.x+n.x)/2,s=o.y<n.y+n.height/2?-1:1,c=o.x>n.x?-1:1,l=c*s,u=t.path();return u.moveTo(o.x,o.y-.8*i),u.bezierCurveTo(a-i*l,o.y-i/2,o.x-i/2*l,n.y+n.height/2-i/3,n.x-n.width/3*c,n.y+n.height/2+3),u.bezierCurveTo(o.x+i/2*l,n.y+n.height/2+i/3,a+i*l,o.y+i/2,o.x,o.y+.8*i),u.closePath(),u}function b(e){var n=e.value,o=t.path(),r=(n.width=this.nextSibling.getBBox().width+45)/2,i=(n.height=this.nextSibling.getBBox().height+30)/2,a=n.k=n.k||t.randomUniform(-20,20)();return o.moveTo(-r,a/3),o.bezierCurveTo(-r,-i+10,-r+10,-i,a,-i),o.bezierCurveTo(r-10,-i,r,-i+10,r,a/3),o.bezierCurveTo(r,i-10,r-10,i,a,i),o.bezierCurveTo(-r+10,i,-r,i-10,-r,a/3),o.closePath(),o}function k(e){var n=D.nodes.get(D.selected),o=D.nodes.get("node0"),r="node"+ ++D.counter,i=Object.assign({},D.options.node,{x:e&&e.x||C(n,o),y:e&&e.y||n.y-t.randomUniform(60,100)(),parent:D.selected});E(r,i)}function w(){var e=D.selected;return"node0"===e?a("The root node can not be deleted"):(D.nodes.remove(e),N(e,function(e,t){D.nodes.remove(t)}),z("node0"),U(),m(),G.call("noderemove",this,e),void 0)}function z(e){var n=D.selected;if("string"!=typeof e)return{key:n,value:s(D.nodes.get(n))};if(D.nodes.has(e)){var o=f(e),r=o.childNodes[0];if(0===r.style.stroke.length){n&&B(n,"");var i=t.color(r.style.fill).darker(.5);r.style.stroke=i,n!==e&&(D.selected=e,G.call("nodeselect",o,e,D.nodes.get(e)))}}else a("The node with the key "+e+" don't exist")}function A(){var e=Object.assign({},D.options["root-node"],{x:parseInt(D.container.style("width"))/2,y:parseInt(D.container.style("height"))/2});E("node"+D.counter,e),M()}function T(e,t,n){e.setAttribute("transform","translate("+[t,n]+")")}function I(e){for(var t=e.parent,n=0;t;){n++;var o=D.nodes.get(t);t=o.parent}return n}function B(e,t){var n=f(e).childNodes[0];return"string"!==t?n.style.stroke=t:n.style.stroke}function E(e,t){D.nodes.set(e,t),_(),G.call("nodecreate",f(e),e,t),m()}function C(e,t){var n;if(e.x>t.x)n=1;else if(e.x<t.x)n=-1;else{var o=function(e){return"node0"===e.parent},r=D.nodes.values().filter(o).length;n=r%2===0?-1:1}return e.x+200*n}function N(e,t){D.nodes.each(function(n,o){n.parent===e&&(t.call(document.getElementById(o),n,o),N(o,t))})}function j(e){var n=t.event.dy,o=t.event.dx,r=e.value.x+=o,i=e.value.y+=n,a=e,s=c(r)===c(r-o);T(this,r,i),e.value.fixed&&N(e.key,function(e){var t=e.x+=o,r=e.y+=n;s||(e.x+=2*(a.value.x-e.x)),T(this,t,r)}),t.selectAll(".branch").attr("d",x),D.dragged=!0}function O(){D.counter=0,D.nodes.clear(),A(),U(),P(),m(),G.call("mmcreate")}function M(){z("node0"),B("node0","")}function P(){var e=D.nodes.get("node0"),n={x:parseInt(D.container.style("width"))/2,y:parseInt(D.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);D.svg.main.transition().duration(500).call(F.transform,o),G.call("mmcenter")}function U(){t.selectAll(".node, .branch").remove(),_()}function _(){var e=D.nodes.entries(),n=D.svg.mmap.selectAll(".node").data(e),o=D.svg.mmap.selectAll(".branch").data(e.slice(1)),r=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",function(e){return e.key}).attr("transform",function(e){return"translate("+e.value.x+","+e.value.y+")"}).call(J).on("dblclick",function(e){t.event.stopPropagation(),G.call("nodedblclick",this,e.key,e.value)});r.append("text").text(function(e){return e.value.name}).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",function(e){return e.value["text-color"]}).style("font-size",function(e){return e.value["font-size"]}).style("font-style",function(e){return l(e.value.italic)}).style("font-weight",function(e){return u(e.value.bold)}),r.insert("path","text").style("fill",function(e){return e.value["background-color"]}).style("stroke-width",3).attr("d",b),o.enter().insert("path","g").style("fill",function(e){return e.value["branch-color"]}).style("stroke",function(e){return e.value["branch-color"]}).attr("class","branch").attr("id",function(e){return"branchOf"+e.key}).attr("d",x),n.exit().remove(),o.exit().remove()}function L(){var e={},t=function(){return S(arguments,e)};window.onkeyup=window.onkeydown=function(r){if(e[r.keyCode]="keydown"===r.type,t("ctrl","maiusc","z"))return!!v();if(t("ctrl","z"))return!!h();if(t("alt","maiusc","up"))X("up");else if(t("alt","maiusc","down"))X("down");else if(t("alt","maiusc","left"))X("left");else if(t("alt","maiusc","right"))X("right");else if(t("alt","maiusc","+"))n();else if(t("alt","maiusc","-"))o();else{if(t("alt","up"))return!!R("up");if(t("alt","down"))return!!R("down");if(t("alt","right"))return!!R("right");if(t("alt","left"))return!!R("left");t("alt","c")?P():t("alt","n")?O():t("alt","+")?k():t("alt","-")?w():t("esc")&&M()}}}function S(e,t){for(var n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,f:70,c:67,n:78,"+":187,"-":189,i:73,z:90},o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function V(e){var t,n=D.nodes.get(D.selected),o=I(n),r=c(n.x),i=Number.MAX_VALUE;D.nodes.each(function(a,s){var l=e?n.y-a.y:a.y-n.y,u=o===I(a),d=D.selected===s,f=r===c(a.x);f&&u&&!d&&l>0&&l<i&&(i=l,t=s)}),void 0!==t&&z(t)}function q(e){var t,n,o=D.nodes.get(D.selected),r=D.nodes.get("node0"),i=Number.MIN_VALUE;D.nodes.each(function(a,s){n=o.x<r.x?e?a.parent===D.selected:o.parent===s:o.x>r.x?e?o.parent===s:a.parent===D.selected:(e?a.x<r.x:a.x>r.x)&&a.parent===D.selected,n&&a.y>i&&(i=a.y,t=s)}),void 0!==t&&z(t)}function R(e){var t="up"===e||"left"===e;"up"===e||"down"===e?V(t):q(t)}function X(e){var n=D.nodes.get(D.selected),o=10,r=c(n.x),i={up:function(e){return e.y-=o},down:function(e){return e.y+=o},right:function(e){return e.x+=o},left:function(e){return e.x-=o}};i[e](n);var a=c(n.x);T(document.getElementById(D.selected),n.x,n.y),n.fixed&&N(D.selected,function(t){i[e](t),a!==r&&(t.x+=2*(n.x-t.x)),T(this,t.x,t.y)}),t.selectAll(".branch").attr("d",x),m()}var D={},F=t.zoom().scaleExtent([.5,2]).on("zoom",function(){D.svg.mmap.attr("transform",t.event.transform)}),G=t.dispatch("mmcreate","mmcenter","nodedblclick","nodeselect","nodeupdate","nodecreate","noderemove"),H=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},J=t.drag().on("drag",j).on("start",function(e){z(e.key)}).on("end",function(){D.dragged&&(D.dragged=!1,m())}),K=function(e,n){D.options={"center-onresize":!1,shortcuts:!0,node:{name:"Node","background-color":"#f9f9f9","text-color":"#808080","branch-color":"#9fad9c","font-size":16,italic:!1,bold:!1,fixed:!0},"root-node":{name:"Root node","background-color":"#e6ede6","text-color":"#828c82","font-size":20,italic:!1,bold:!1,fixed:!1}},D.container=t.select(e),D.history={index:-1,snapshots:[]},D.svg={},D.svg.main=D.container.append("svg").attr("width","100%").attr("height","100%").call(F),D.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",M),D.svg.mmap=D.svg.main.append("g"),D.nodes=t.map(),D.counter=0,void 0!==n&&(n.constructor===Object?d(D.options,n):a("mmap options invalid")),D.options["center-onresize"]===!0&&(onresize=P),D.options.shortcuts===!0&&L(),G.call("mmcreate"),A()};e.init=K,e.on=i,Object.defineProperty(e,"__esModule",{value:!0})});
