!function(e,t){function n(n){D.container=t.select(n),D.history={index:-1,snapshots:[]},D.svg={},D.svg.main=D.container.append("svg").attr("width","100%").attr("height","100%").call(_),D.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",c),D.svg.mmap=D.svg.main.append("g"),D.nodes=t.map(),D.counter=0,h(),m(),y(),c(),C(),e.onresize=R,F.call("mmcreate")}function o(){D.svg.mmap.attr("transform",t.event.transform)}function s(e){D.dragged=!0;const n=e.x=t.event.x,o=e.y=t.event.y;t.select(this).attr("transform","translate("+n+","+o+")"),t.selectAll(".branch").attr("d",A)}function r(e){if(D.selected!==e||"node0"===D.selected){t.selectAll(".node > path").style("stroke","none"),D.selected=e;const n=t.select("#"+e),o=n.select("path");o.style("stroke",t.color(o.style("fill")).darker(.5)),F.call("nodeselect",n.node(),D.nodes.get(e))}}function c(){r("node0"),t.select("#node0 > path").style("stroke","none")}function i(e){for(var t=e.parent,n=0;t;){n++;const e=D.nodes.get(t);t=e.parent}return n}function l(){const e=[];return D.nodes.each(function(t,n){t.key=n,e.push(t)}),e}function a(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const r=n[o].cssRules;for(var s=0;s<r.length;s++){const n=r[s],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function d(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function f(){const t=D.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=t.getBBox(),s=15,r=o.x-s,c=o.y-s,i=o.width+30,l=o.height+30,f="http://www.w3.org/2000/xmlns/";n.setAttributeNS(f,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(f,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",i),n.setAttribute("height",l),n.setAttribute("viewBox",[r,c,i,l].join(" "));const h=a(t),u=document.createElement("style"),y=document.createElement("defs");u.setAttribute("type","text/css"),u.innerHTML="<![CDATA[\n"+h+"\n]]>",y.appendChild(u),n.appendChild(y);const g=t.cloneNode(!0);g.setAttribute("transform","translate(0,0)"),n.appendChild(g);const m=e.btoa(d(n.outerHTML));return"data:image/svg+xml;base64,"+m}function h(){D.nodes.set("node"+D.counter,{name:"Root node",x:parseInt(D.container.style("width"))/2,y:parseInt(D.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function u(e){const n=t.map();return e.each(function(e,t){n.set(t,Object.assign({},e))}),n}function y(){const e=D.history,t=e.snapshots.length;e.index<t-1&&console.log(e.index),e.index=e.snapshots.length,e.snapshots.push(u(D.nodes)),console.info("Snapshot saved!")}function g(){t.selectAll(".node, .branch").remove(),m()}function m(){const e=l(),n=D.svg.mmap.selectAll(".node").data(e),o=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.x+","+e.y+")").call(q).on("dblclick",function(e){F.call("nodedblclick",this,e),t.event.stopPropagation()});o.append("text").text(e=>e.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",e=>e["text-color"]).style("font-size",e=>e["font-size"]).style("font-style",e=>e["font-style"]).style("font-weight",e=>e["font-weight"]),o.insert("path","text").style("fill",e=>e["background-color"]).style("stroke-width",3).attr("d",N),n.exit().remove();const s=D.svg.mmap.selectAll(".branch").data(e.slice(1));s.enter().insert("path","g").style("fill",e=>e["branch-color"]).style("stroke",e=>e["branch-color"]).attr("class","branch").attr("id",e=>"branchOf"+e.key).attr("d",A),s.exit().remove()}function p(e,n){if(e.name!=n){console.log("updated");const o=this.childNodes[1],s=this.childNodes[0];e.name=o.innerHTML=n,e.width=o.textLength.baseVal.value+45,t.select(s).attr("d",N),y()}}function x(e,n){if(e["background-color"]!==n){const o=this.childNodes[0];o.style.setProperty("fill",e["background-color"]=n),o.style.setProperty("stroke",t.color(n).darker(.5)),y()}}function w(e,t){if(e["text-color"]!==t){const n=this.childNodes[1];n.style.setProperty("fill",e["text-color"]=t),y()}}function b(e,n){if(e["font-size"]!=n){const o=this.childNodes[1],s=this.childNodes[0];o.style.setProperty("font-size",e["font-size"]=n),e.width=o.textLength.baseVal.value+45,e.height=11*e["font-size"]/10+30,t.select(s).attr("d",N),t.selectAll(".branch").attr("d",A),y()}}function k(e){const t=this.childNodes[1];e["font-style"]="normal"===e["font-style"]?"italic":"normal",t.style.setProperty("font-style",e["font-style"]),y()}function v(e){const t=this.childNodes[1];e["font-weight"]="normal"===e["font-weight"]?"bold":"normal",t.style.setProperty("font-weight",e["font-weight"]),y()}function z(e,t){if("node0"!==e.key){if(e["branch-color"]!==t){const n=document.getElementById("branchOf"+e.key);n.style.setProperty("fill",e["branch-color"]=t),n.style.setProperty("stroke",e["branch-color"]=t),y()}}else console.warn("The root node has no branches")}function A(e){const n=D.nodes.get(e.parent),o=i(e),s=22-3*(o<5?o:5),r=(n.x+e.x)/2,c=n.y<e.y+e.height/2?-1:1,l=n.x>e.x?-1:1,a=l*c,d=t.path();return d.moveTo(n.x,n.y-.8*s),d.bezierCurveTo(r-s*a,n.y-s/2,n.x-s/2*a,e.y+e.height/2-s/3,e.x-e.width/3*l,e.y+e.height/2+3),d.bezierCurveTo(n.x+s/2*a,e.y+e.height/2+s/3,r+s*a,n.y+s/2,n.x,n.y+.8*s),d.closePath(),d}function N(e){const n=t.path(),o=(e.width=this.nextSibling.getBBox().width+45)/2,s=(e.height=11*e["font-size"]/10+30)/2,r=e.k=e.k||t.randomUniform(-20,20)();return n.moveTo(-o,r/3),n.bezierCurveTo(-o,-s+10,-o+10,-s,r,-s),n.bezierCurveTo(o-10,-s,o,-s+10,o,r/3),n.bezierCurveTo(o,s-10,o-10,s,r,s),n.bezierCurveTo(-o+10,s,-o,s-10,-o,r/3),n.closePath(),n}function C(e,t){var n={},o=function(){return T(arguments,n)};onkeyup=onkeydown=function(e){return n[e.keyCode]="keydown"===e.type,o("ctrl","maiusc","z")?(j(),!1):o("ctrl","z")?(H(),!1):void(o("ctrl","up")?L("up"):o("ctrl","down")?L("down"):o("ctrl","left")?L("left"):o("ctrl","right")?L("right"):o("up")?S("up"):o("down")?S("down"):o("right")?S("right"):o("left")?S("left"):o("i")?O("mmap"):o("c")?R():o("n")?V():o("+")?B():o("-")?M():o("enter")?E():o("esc")&&c())}}function T(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,enter:13,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function E(){const e=t.select("#"+D.selected),n=e.select("path");n.style("stroke",t.color(n.style("fill")).darker(.5));const o=new MouseEvent("dblclick");e.node().dispatchEvent(o)}function I(e,t){const n=D.nodes.get("node0"),o=i(e),s=n.x>e.x;var r,c=Number.MAX_VALUE;return D.nodes.each(function(l,a){const d=t?e.y-l.y:l.y-e.y,f=o===i(l),h=e.key===l.key,u=s&&n.x>l.x||!s&&n.x<l.x;u&&f&&!h&&d>0&&d<c&&(c=d,r=l.key)}),r||e.key}function P(e,t){const n=D.nodes.get("node0");var o,s,r=Number.MIN_VALUE;return D.nodes.each(function(c,i){s=e.x<n.x?t?c.parent===e.key:e.parent===c.key:e.x>n.x?t?e.parent===c.key:c.parent===e.key:(t?c.x<n.x:c.x>n.x)&&c.parent===e.key,s&&c.y>r&&(r=c.y,o=c.key)}),o||e.key}function S(e){const t=D.nodes.get(D.selected);r({up:I,down:I,left:P,right:P}[e](t,"up"===e||"left"===e))}function L(e){const n=D.nodes.get(D.selected),o=t.select("#"+D.selected),s=10;switch(e){case"up":n.y-=s;break;case"down":n.y+=s;break;case"right":n.x+=s;break;case"left":n.x-=s}o.attr("transform",e=>"translate("+e.x+","+e.y+")"),t.selectAll(".branch").attr("d",A)}function B(e){if(D.selected){const t=D.nodes.get(D.selected),n=D.nodes.get("node0"),o="node"+ ++D.counter,s={name:e&&e.name||"Node","background-color":e&&e["background-color"]||"#f1f1f1","text-color":e&&e["text-color"]||"#808080","branch-color":e&&e["branch-color"]||t["branch-color"]||"#9fad9c","font-size":e&&e["font-size"]||16,"font-style":e&&e["font-style"]||"normal","font-weight":e&&e["font-weight"]||"normal",x:t.x+(t.x>n.x?200:-200),y:t.y+50,parent:t.key};D.nodes.set(o,s),m(),F.call("nodecreate"),y()}}function M(){if("node0"!==D.selected){D.nodes.remove(D.selected);const e=function(t){D.nodes.each(function(n){if("node0"!==n.key&&n.parent===t)return D.nodes.remove(n.key),void e(n.key)})};e(D.selected),r("node0"),g(),F.call("noderemove"),y()}else console.warn("The root node can not be deleted")}function R(){const e=D.nodes.get("node0"),n={x:parseInt(D.container.style("width"))/2,y:parseInt(D.container.style("height"))/2},o=t.zoomIdentity.translate(n.x-e.x,n.y-e.y);D.svg.main.transition().duration(500).call(_.transform,o),F.call("mmcenter")}function U(e,t){const n=D.nodes.get(D.selected),o=document.getElementById(n.key),s={name:p,"background-color":x,"branch-color":z,"text-color":w,"font-size":b,"font-style":k,"font-weight":v,default:function(){console.error('"'+e+'" is not a valid node property')}};(s[e]||s.default).call(o,n,t)}function O(e,t){const n=new Image;n.src=f(),n.onload=function(){const o=document.createElement("canvas"),s=o.getContext("2d"),r=document.createElement("a");o.width=n.width,o.height=n.height,s.drawImage(n,0,0),s.globalCompositeOperation="destination-over",s.fillStyle=t||"#ffffff",s.fillRect(0,0,o.width,o.height),r.download=e,r.href=o.toDataURL("image/png"),r.click()}}function V(){D.counter=0,D.nodes.clear(),h(),g(),y(),c(),R()}function H(){const e=D.history;if(e.index>0){e.index--;const t=e.snapshots[e.index];D.nodes=u(t),r("node0"),g()}}function j(){const e=D.history;if(e.index<e.snapshots.length-1){e.index++;const t=e.snapshots[e.index];D.nodes=u(t),r("node0"),g()}}const D={},_=t.zoom().scaleExtent([.5,2]).on("zoom",o),q=t.drag().on("drag",s).on("start",function(e){r(e.key)}).on("end",function(){D.dragged&&(D.dragged=!1,y())}),F=t.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");e.mmap={init:n,center:R,undo:H,repeat:j,newMap:V,addNode:B,removeNode:M,updateNode:U,events:F,getPNG:O}}(this,window.d3);