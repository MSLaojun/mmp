!function(t,e){function n(n){F.container=e.select(n),F.history={index:-1,snapshots:[]},F.svg={},F.svg.main=F.container.append("svg").attr("width","100%").attr("height","100%").call(G),F.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",c),F.svg.mmap=F.svg.main.append("g"),F.nodes=e.map(),F.counter=0,h(),x(),g(),c(),E(),t.onresize=U,K.call("mmcreate")}function o(){F.svg.mmap.attr("transform",e.event.transform)}function s(t){F.dragged=!0;const n=t.x=e.event.x,o=t.y=e.event.y;e.select(this).attr("transform","translate("+n+","+o+")"),e.selectAll(".branch").attr("d",C)}function r(t){if(F.selected!==t||"node0"===F.selected){e.selectAll(".node > path").style("stroke","none"),F.selected=t;const n=e.select("#"+t),o=n.select("path");o.style("stroke",e.color(o.style("fill")).darker(.5)),K.call("nodeselect",n.node(),F.nodes.get(t))}}function c(){r("node0"),e.select("#node0 > path").style("stroke","none")}function i(t){for(var e=t.parent,n=0;e;){n++;const t=F.nodes.get(e);e=t.parent}return n}function l(){const t=[];return F.nodes.each(function(e,n){e.key=n,t.push(e)}),t}function a(t){var e="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const r=n[o].cssRules;for(var s=0;s<r.length;s++){const n=r[s],o=n.cssText.match(/^@font-face/);(t.querySelector(n.selectorText)||o)&&(e+=n.cssText)}}return e}function d(t){return t=encodeURIComponent(t),t=t.replace(/%([0-9A-F]{2})/g,function(t,e){const n=String.fromCharCode("0x"+e);return"%"===n?"%25":n}),decodeURIComponent(t)}function f(){const e=F.svg.mmap.node(),n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=e.getBBox(),s=15,r=o.x-s,c=o.y-s,i=o.width+30,l=o.height+30,f="http://www.w3.org/2000/xmlns/";n.setAttributeNS(f,"xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(f,"xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1"),n.setAttribute("width",i),n.setAttribute("height",l),n.setAttribute("viewBox",[r,c,i,l].join(" "));const h=a(e),u=document.createElement("style"),y=document.createElement("defs");u.setAttribute("type","text/css"),u.innerHTML="<![CDATA[\n"+h+"\n]]>",y.appendChild(u),n.appendChild(y);const g=e.cloneNode(!0);g.setAttribute("transform","translate(0,0)"),n.appendChild(g);const m=t.btoa(d(n.outerHTML));return"data:image/svg+xml;base64,"+m}function h(){F.nodes.set("node"+F.counter,{name:"Root node",x:parseInt(F.container.style("width"))/2,y:parseInt(F.container.style("height"))/2,"background-color":"#e6ede6","text-color":"#828c82","font-size":20,"font-style":"normal","font-weight":"normal"})}function u(){const t=t=>parseInt(t.substring(4)),e=F.nodes.keys().map(t);F.counter=Math.max(...e)}function y(t){const n=e.map();return t.forEach(function(t){n.set(t.key,Object.assign({},t.value))}),n}function g(){const t=F.history;t.index<t.snapshots.length-1&&t.snapshots.splice(t.index+1);const e=JSON.parse(JSON.stringify(F.nodes.entries()));t.snapshots.push(e),t.index++}function m(t){F.nodes=y(t),p(),c(),u()}function p(){e.selectAll(".node, .branch").remove(),x()}function x(){const t=l(),n=F.svg.mmap.selectAll(".node").data(t),o=n.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",t=>t.key).attr("transform",t=>"translate("+t.x+","+t.y+")").call(X).on("dblclick",function(t){K.call("nodedblclick",this,t),e.event.stopPropagation()});o.append("text").text(t=>t.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",t=>t["text-color"]).style("font-size",t=>t["font-size"]).style("font-style",t=>t["font-style"]).style("font-weight",t=>t["font-weight"]),o.insert("path","text").style("fill",t=>t["background-color"]).style("stroke-width",3).attr("d",T),n.exit().remove();const s=F.svg.mmap.selectAll(".branch").data(t.slice(1));s.enter().insert("path","g").style("fill",t=>t["branch-color"]).style("stroke",t=>t["branch-color"]).attr("class","branch").attr("id",t=>"branchOf"+t.key).attr("d",C),s.exit().remove()}function w(t,n){if(t.name!=n){const o=this.childNodes[1],s=this.childNodes[0];t.name=o.innerHTML=n,t.width=o.textLength.baseVal.value+45,e.select(s).attr("d",T),g()}}function b(t,n){if(t["background-color"]!==n){const o=this.childNodes[0];o.style.setProperty("fill",t["background-color"]=n),o.style.setProperty("stroke",e.color(n).darker(.5)),g()}}function k(t,e){if(t["text-color"]!==e){const n=this.childNodes[1];n.style.setProperty("fill",t["text-color"]=e),g()}}function v(t,n){if(t["font-size"]!=n){const o=this.childNodes[1],s=this.childNodes[0];o.style.setProperty("font-size",t["font-size"]=n),t.width=o.textLength.baseVal.value+45,t.height=11*t["font-size"]/10+30,e.select(s).attr("d",T),e.selectAll(".branch").attr("d",C),g()}}function z(t){const e=this.childNodes[1];t["font-style"]="normal"===t["font-style"]?"italic":"normal",e.style.setProperty("font-style",t["font-style"]),g()}function N(t){const e=this.childNodes[1];t["font-weight"]="normal"===t["font-weight"]?"bold":"normal",e.style.setProperty("font-weight",t["font-weight"]),g()}function A(t,e){if("node0"!==t.key){if(t["branch-color"]!==e){const n=document.getElementById("branchOf"+t.key);n.style.setProperty("fill",t["branch-color"]=e),n.style.setProperty("stroke",t["branch-color"]=e),g()}}else console.warn("The root node has no branches")}function C(t){const n=F.nodes.get(t.parent),o=i(t),s=22-3*(o<5?o:5),r=(n.x+t.x)/2,c=n.y<t.y+t.height/2?-1:1,l=n.x>t.x?-1:1,a=l*c,d=e.path();return d.moveTo(n.x,n.y-.8*s),d.bezierCurveTo(r-s*a,n.y-s/2,n.x-s/2*a,t.y+t.height/2-s/3,t.x-t.width/3*l,t.y+t.height/2+3),d.bezierCurveTo(n.x+s/2*a,t.y+t.height/2+s/3,r+s*a,n.y+s/2,n.x,n.y+.8*s),d.closePath(),d}function T(t){const n=e.path(),o=(t.width=this.nextSibling.getBBox().width+45)/2,s=(t.height=11*t["font-size"]/10+30)/2,r=t.k=t.k||e.randomUniform(-20,20)();return n.moveTo(-o,r/3),n.bezierCurveTo(-o,-s+10,-o+10,-s,r,-s),n.bezierCurveTo(o-10,-s,o,-s+10,o,r/3),n.bezierCurveTo(o,s-10,o-10,s,r,s),n.bezierCurveTo(-o+10,s,-o,s-10,-o,r/3),n.closePath(),n}function E(t,e){var n={},o=function(){return I(arguments,n)};onkeyup=onkeydown=function(t){return n[t.keyCode]="keydown"===t.type,o("ctrl","maiusc","z")?(J(),!1):o("ctrl","z")?(D(),!1):void(o("ctrl","up")?M("up"):o("ctrl","down")?M("down"):o("ctrl","left")?M("left"):o("ctrl","right")?M("right"):o("up")?B("up"):o("down")?B("down"):o("right")?B("right"):o("left")?B("left"):o("i")?getPNG("mmap"):o("c")?U():o("n")?j():o("+")?O():o("-")?R():o("enter")?P():o("esc")&&c())}}function I(t,e){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,enter:13,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<t.length;o++)if(!e[n[t[o]]])return!1;return!0}function P(){const t=e.select("#"+F.selected),n=t.select("path");n.style("stroke",e.color(n.style("fill")).darker(.5));const o=new MouseEvent("dblclick");t.node().dispatchEvent(o)}function S(t,e){const n=F.nodes.get("node0"),o=i(t),s=n.x>t.x;var r,c=Number.MAX_VALUE;return F.nodes.each(function(l,a){const d=e?t.y-l.y:l.y-t.y,f=o===i(l),h=t.key===l.key,u=s&&n.x>l.x||!s&&n.x<l.x;u&&f&&!h&&d>0&&d<c&&(c=d,r=l.key)}),r||t.key}function L(t,e){const n=F.nodes.get("node0");var o,s,r=Number.MIN_VALUE;return F.nodes.each(function(c,i){s=t.x<n.x?e?c.parent===t.key:t.parent===c.key:t.x>n.x?e?t.parent===c.key:c.parent===t.key:(e?c.x<n.x:c.x>n.x)&&c.parent===t.key,s&&c.y>r&&(r=c.y,o=c.key)}),o||t.key}function B(t){const e=F.nodes.get(F.selected);r({up:S,down:S,left:L,right:L}[t](e,"up"===t||"left"===t))}function M(t){const n=F.nodes.get(F.selected),o=e.select("#"+F.selected),s=10;switch(t){case"up":n.y-=s;break;case"down":n.y+=s;break;case"right":n.x+=s;break;case"left":n.x-=s}o.attr("transform",t=>"translate("+t.x+","+t.y+")"),e.selectAll(".branch").attr("d",C),g()}function O(t){if(F.selected){const e=F.nodes.get(F.selected),n=F.nodes.get("node0"),o="node"+ ++F.counter,s={name:t&&t.name||"Node","background-color":t&&t["background-color"]||"#f1f1f1","text-color":t&&t["text-color"]||"#808080","branch-color":t&&t["branch-color"]||e["branch-color"]||"#9fad9c","font-size":t&&t["font-size"]||16,"font-style":t&&t["font-style"]||"normal","font-weight":t&&t["font-weight"]||"normal",x:e.x+(e.x>n.x?200:-200),y:e.y+50,parent:e.key};F.nodes.set(o,s),x(),K.call("nodecreate"),g()}}function R(){if("node0"!==F.selected){F.nodes.remove(F.selected);const t=function(e){F.nodes.each(function(n){if("node0"!==n.key&&n.parent===e)return F.nodes.remove(n.key),void t(n.key)})};t(F.selected),r("node0"),p(),K.call("noderemove"),g()}else console.warn("The root node can not be deleted")}function U(){const t=F.nodes.get("node0"),n={x:parseInt(F.container.style("width"))/2,y:parseInt(F.container.style("height"))/2},o=e.zoomIdentity.translate(n.x-t.x,n.y-t.y);F.svg.main.transition().duration(500).call(G.transform,o),K.call("mmcenter")}function V(t,e){const n=F.nodes.get(F.selected),o=document.getElementById(n.key),s={name:w,"background-color":b,"branch-color":A,"text-color":k,"font-size":v,"font-style":z,"font-weight":N,default:function(){console.error('"'+t+'" is not a valid node property')}};(s[t]||s.default).call(o,n,e)}function H(t,e){const n=new Image;n.src=f(),n.onload=function(){const o=document.createElement("canvas"),s=o.getContext("2d"),r=document.createElement("a");o.width=n.width,o.height=n.height,s.drawImage(n,0,0),s.globalCompositeOperation="destination-over",s.fillStyle=e||"#ffffff",s.fillRect(0,0,o.width,o.height),r.download=t,r.href=o.toDataURL("image/png"),r.click()}}function j(){F.counter=0,F.nodes.clear(),h(),p(),g(),c(),U()}function D(){const t=F.history;t.index>0&&(t.index--,m(t.snapshots[t.index]))}function J(){const t=F.history;t.index<t.snapshots.length-1&&(t.index++,m(t.snapshots[t.index]))}function _(){return F.history.snapshots[F.history.index]}function q(t){m(t),g()}const F={},G=e.zoom().scaleExtent([.5,2]).on("zoom",o),X=e.drag().on("drag",s).on("start",function(t){r(t.key)}).on("end",function(){F.dragged&&(F.dragged=!1,g())}),K=e.dispatch("mmcreate","mmcenter","nodeselect","nodecreate","noderemove","nodedblclick");t.mmap={init:n,center:U,undo:D,repeat:J,new:j,events:K,png:H,data:_,load:q,addNode:O,removeNode:R,updateNode:V}}(this,window.d3);