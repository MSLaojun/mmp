!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.mmap=e.mmap||{})}(this,function(e){"use strict";function t(e,t){ce.options={"center-onresize":!1,shortcuts:!0,node:{name:"Node","background-color":"#f9f9f9","text-color":"#808080","branch-color":"#9fad9c","font-size":16,italic:!1,bold:!1,fixed:!0},"root-node":{name:"Root node","background-color":"#e6ede6","text-color":"#828c82","font-size":20,italic:!1,bold:!1,fixed:!1}},ce.container=d3.select(e),ce.history={index:-1,snapshots:[]},ce.svg={},ce.svg.main=ce.container.append("svg").attr("width","100%").attr("height","100%").call(re),ce.svg.main.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",f),ce.svg.mmap=ce.svg.main.append("g"),ce.nodes=d3.map(),ce.counter=0,void 0!==t&&(t.constructor===Object?v(ce.options,t):i("mmap options invalid")),ce.options["center-onresize"]===!0&&(onresize=Y),ce.options.shortcuts===!0&&_(),de.call("mmcreate"),x()}function n(){ce.svg.mmap.attr("transform",d3.event.transform)}function o(e,t){var n;if(e.x>t.x)n=1;else if(e.x<t.x)n=-1;else{const e=e=>"node0"===e.parent,t=ce.nodes.values().filter(e).length;n=t%2===0?-1:1}return e.x+200*n}function s(e){return e<ce.nodes.get("node0").x}function i(e){return console.error(e),!1}function c(e,t,n){e.setAttribute("transform","translate("+[t,n]+")")}function r(e){const t=ce.svg.main;var n=d3.zoomTransform(t.node()).k;n+=e?n/5:-n/5,re.scaleTo(t.transition().duration(100),n)}function l(e){const t=d3.event.dy,n=d3.event.dx,o=e.value.x+=n,i=e.value.y+=t,r=e,l=s(o)===s(o-n);c(this,o,i),e.value.fixed&&d(e.key,function(e,o){const s=e.x+=n,i=e.y+=t;l||(e.x+=2*(r.value.x-e.x)),c(this,s,i)}),d3.selectAll(".branch").attr("d",R),ce.dragged=!0}function d(e,t){ce.nodes.each(function(n,o){n.parent===e&&(t.call(document.getElementById(o),n,o),d(o,t))})}function a(e){const t=e.substring(0,1),n=e.substring(1);return"."===t?document.getElementsByClassName(n):"#"===t?document.getElementById(n):e.includes("node")?document.getElementById(e):document.getElementsByTagName(e)}function u(e,t){const n=a(e).childNodes[0];return"string"!==t?n.style.stroke=t:n.style.stroke}function f(){J("node0"),u("node0","")}function h(e){for(var t=e.parent,n=0;t;){n++;const e=ce.nodes.get(t);t=e.parent}return n}function m(e){return Object.assign({},e)}function g(e){var t="";const n=document.styleSheets;for(var o=0;o<n.length;o++){const i=n[o].cssRules;for(var s=0;s<i.length;s++){const n=i[s],o=n.cssText.match(/^@font-face/);(e.querySelector(n.selectorText)||o)&&(t+=n.cssText)}}return t}function y(e){return e?"italic":"normal"}function p(e){return e?"bold":"normal"}function x(){const e=Object.assign({},ce.options["root-node"],{x:parseInt(ce.container.style("width"))/2,y:parseInt(ce.container.style("height"))/2});b("node"+ce.counter,e),f()}function v(e,t){for(let n in e){var o=e[n],s=t[n];s&&s.constructor===o.constructor&&(s.constructor===Object?v(o,s):e[n]=s)}}function b(e,t){ce.nodes.set(e,t),I(),de.call("nodecreate",a(e),e,t),T()}function w(e){return e=encodeURIComponent(e),e=e.replace(/%([0-9A-F]{2})/g,function(e,t){const n=String.fromCharCode("0x"+t);return"%"===n?"%25":n}),decodeURIComponent(e)}function k(){const e=ce.svg.mmap.node(),t=document.createElementNS("http://www.w3.org/2000/svg","svg"),n="http://www.w3.org/2000/xmlns/",o=e.getBBox(),s=15,i=o.x-s,c=o.y-s,r=o.width+30,l=o.height+30;t.setAttributeNS(n,"xmlns","http://www.w3.org/2000/svg"),t.setAttributeNS(n,"xmlns:xlink","http://www.w3.org/1999/xlink"),t.setAttribute("version","1.1"),t.setAttribute("width",r),t.setAttribute("height",l),t.setAttribute("viewBox",[i,c,r,l].join(" "));const d=g(e),a=document.createElement("style"),u=document.createElement("defs");a.setAttribute("type","text/css"),a.innerHTML="<![CDATA[\n"+d+"\n]]>",u.appendChild(a),t.appendChild(u);const f=e.cloneNode(!0);f.setAttribute("transform","translate(0,0)"),t.appendChild(f);const h=window.btoa(w(t.outerHTML));return"data:image/svg+xml;base64,"+h}function z(){const e=e=>parseInt(e.substring(4)),t=ce.nodes.keys().map(e);ce.counter=Math.max(...t)}function A(){return ce.nodes.entries().map(function(e){const t=m(e.value);return delete t.width,delete t.height,{key:e.key,value:t}})}function T(){const e=ce.history;e.index<e.snapshots.length-1&&e.snapshots.splice(e.index+1),e.snapshots.push(A()),e.index++}function N(e){ce.nodes.clear(),e.forEach(function(e){ce.nodes.set(e.key,m(e.value))}),C(),z(),f()}function C(){d3.selectAll(".node, .branch").remove(),I()}function I(){const e=ce.nodes.entries(),t=ce.svg.mmap.selectAll(".node").data(e),n=ce.svg.mmap.selectAll(".branch").data(e.slice(1)),o=t.enter().append("g").style("cursor","pointer").attr("class","node").attr("id",e=>e.key).attr("transform",e=>"translate("+e.value.x+","+e.value.y+")").call(le).on("dblclick",function(e){d3.event.stopPropagation(),de.call("nodedblclick",this,e.key,e.value)});o.append("text").text(e=>e.value.name).style("font-family","sans-serif").style("text-anchor","middle").style("alignment-baseline","middle").style("fill",e=>e.value["text-color"]).style("font-size",e=>e.value["font-size"]).style("font-style",e=>y(e.value.italic)).style("font-weight",e=>p(e.value.bold)),o.insert("path","text").style("fill",e=>e.value["background-color"]).style("stroke-width",3).attr("d",P),n.enter().insert("path","g").style("fill",e=>e.value["branch-color"]).style("stroke",e=>e.value["branch-color"]).attr("class","branch").attr("id",e=>"branchOf"+e.key).attr("d",R),t.exit().remove(),n.exit().remove()}function E(e,t,n){return!(e.name==t&&!n)&&(this.childNodes[1].innerHTML=t,d3.select(this.childNodes[0]).attr("d",P),d3.selectAll(".branch").attr("d",R),n||(e.name=t),void 0)}function B(e,t,n){if(e["background-color"]===t&&!n)return!1;{const o=this.childNodes[0];o.style.fill=t,""!==o.style.stroke&&(o.style.stroke=d3.color(t).darker(.5)),n||(e["background-color"]=t)}}function O(e,t,n){return!(e["text-color"]===t&&!n)&&(this.childNodes[1].style.fill=t,void(n||(e["text-color"]=t)))}function S(e,t,n){if("node0"===ce.selected)return i("The root node has no branches");if(e["branch-color"]===t&&!n)return!1;{const o=document.getElementById("branchOf"+ce.selected);o.style.fill=o.style.stroke=t,n||(e["branch-color"]=t)}}function j(e,t,n){return!(e["font-size"]==t&&!n)&&(this.childNodes[1].style["font-size"]=t,d3.select(this.childNodes[0]).attr("d",P),d3.selectAll(".branch").attr("d",R),n||(e["font-size"]=t),void 0)}function M(e){const t=y(e.italic=!e.italic);this.childNodes[1].style["font-style"]=t}function U(e){const t=p(e.bold=!e.bold);this.childNodes[1].style["font-weight"]=t}function L(e){return"node0"===ce.selected?i("The root node can not be fixed"):void(e.fixed=!e.fixed)}function R(e){const t=e.value,n=ce.nodes.get(t.parent),o=h(t),s=22-3*(o<5?o:5),i=(n.x+t.x)/2,c=n.y<t.y+t.height/2?-1:1,r=n.x>t.x?-1:1,l=r*c,d=d3.path();return d.moveTo(n.x,n.y-.8*s),d.bezierCurveTo(i-s*l,n.y-s/2,n.x-s/2*l,t.y+t.height/2-s/3,t.x-t.width/3*r,t.y+t.height/2+3),d.bezierCurveTo(n.x+s/2*l,t.y+t.height/2+s/3,i+s*l,n.y+s/2,n.x,n.y+.8*s),d.closePath(),d}function P(e){const t=e.value,n=d3.path(),o=(t.width=this.nextSibling.getBBox().width+45)/2,s=(t.height=this.nextSibling.getBBox().height+30)/2,i=t.k=t.k||d3.randomUniform(-20,20)();return n.moveTo(-o,i/3),n.bezierCurveTo(-o,-s+10,-o+10,-s,i,-s),n.bezierCurveTo(o-10,-s,o,-s+10,o,i/3),n.bezierCurveTo(o,s-10,o-10,s,i,s),n.bezierCurveTo(-o+10,s,-o,s-10,-o,i/3),n.closePath(),n}function _(){const e={},t=function(){return H(arguments,e)};onkeyup=onkeydown=function(n){if(e[n.keyCode]="keydown"===n.type,t("ctrl","maiusc","z"))return!!$();if(t("ctrl","z"))return!!Z();if(t("alt","maiusc","up"))F("up");else if(t("alt","maiusc","down"))F("down");else if(t("alt","maiusc","left"))F("left");else if(t("alt","maiusc","right"))F("right");else if(t("alt","maiusc","+"))te();else if(t("alt","maiusc","-"))ne();else{if(t("alt","up"))return!!q("up");if(t("alt","down"))return!!q("down");if(t("alt","right"))return!!q("right");if(t("alt","left"))return!!q("left");t("alt","i")?png("mmap"):t("alt","c")?Y():t("alt","n")?W():t("alt","+")?X():t("alt","-")?G():t("esc")&&f()}}}function H(e,t){const n={up:38,down:40,right:39,left:37,ctrl:17,alt:18,maiusc:16,esc:27,f:70,c:67,n:78,"+":187,"-":189,i:73,z:90};for(var o=0;o<e.length;o++)if(!t[n[e[o]]])return!1;return!0}function D(e){const t=ce.nodes.get(ce.selected),n=h(t),o=s(t.x);var i,c=Number.MAX_VALUE;ce.nodes.each(function(r,l){const d=e?t.y-r.y:r.y-t.y,a=n===h(r),u=ce.selected===l,f=o===s(r.x);f&&a&&!u&&d>0&&d<c&&(c=d,i=l)}),void 0!==i&&J(i)}function V(e){const t=ce.nodes.get(ce.selected),n=ce.nodes.get("node0");var o,s,i=Number.MIN_VALUE;ce.nodes.each(function(c,r){s=t.x<n.x?e?c.parent===ce.selected:t.parent===r:t.x>n.x?e?t.parent===r:c.parent===ce.selected:(e?c.x<n.x:c.x>n.x)&&c.parent===ce.selected,s&&c.y>i&&(i=c.y,o=r)}),void 0!==o&&J(o)}function q(e){const t="up"===e||"left"===e;"up"===e||"down"===e?D(t):V(t)}function F(e){const t=ce.nodes.get(ce.selected),n=10,o=s(t.x),i={up:e=>e.y-=n,down:e=>e.y+=n,right:e=>e.x+=n,left:e=>e.x-=n};i[e](t);const r=s(t.x);c(document.getElementById(ce.selected),t.x,t.y),t.fixed&&d(ce.selected,function(n,s){i[e](n),r!==o&&(n.x+=2*(t.x-n.x)),c(this,n.x,n.y)}),d3.selectAll(".branch").attr("d",R),T()}function X(e){const t=ce.nodes.get(ce.selected),n=ce.nodes.get("node0"),s="node"+ ++ce.counter,i=Object.assign({},ce.options.node,{x:e&&e.x||o(t,n),y:e&&e.y||t.y-d3.randomUniform(60,100)(),parent:ce.selected});b(s,i)}function G(){const e=ce.selected;return"node0"===e?i("The root node can not be deleted"):(ce.nodes.remove(e),d(e,function(e,t){ce.nodes.remove(t)}),J("node0"),C(),T(),de.call("noderemove",this,e),void 0)}function J(e){const t=ce.selected;if("string"!=typeof e)return{key:t,value:m(ce.nodes.get(t))};if(ce.nodes.has(e)){const n=a(e),o=n.childNodes[0];if(0===o.style.stroke.length){t&&u(t,"");const s=d3.color(o.style.fill).darker(.5);o.style.stroke=s,t!==e&&(ce.selected=e,de.call("nodeselect",n,e,ce.nodes.get(e)))}}else i("The node with the key "+e+" don't exist")}function K(e,t,n){const o=ce.nodes.get(ce.selected),s=document.getElementById(ce.selected),c={name:E,fixed:L,"background-color":B,"branch-color":S,"text-color":O,"font-size":j,italic:M,bold:U},r=c[e];return void 0===r?i('"'+e+'" is not a valid node property'):void(r.call(s,o,t,n)!==!1&&(n||T(),de.call("nodeupdate",s,ce.selected,o,e)))}function Q(e,t,n){const o=new Image;o.src=k(),o.onload=function(){const s=document.createElement("canvas"),i=s.getContext("2d");document.createElement("a");s.width=o.width,s.height=o.height,i.drawImage(o,0,0),i.globalCompositeOperation="destination-over",i.fillStyle=n||"#ffffff",i.fillRect(0,0,s.width,s.height),e(s.toDataURL(t))}}function W(){ce.counter=0,ce.nodes.clear(),x(),C(),Y(),T(),de.call("mmcreate")}function Y(){const e=ce.nodes.get("node0"),t={x:parseInt(ce.container.style("width"))/2,y:parseInt(ce.container.style("height"))/2},n=d3.zoomIdentity.translate(t.x-e.x,t.y-e.y);ce.svg.main.transition().duration(500).call(re.transform,n),de.call("mmcenter")}function Z(){const e=ce.history;e.index>0&&N(e.snapshots[--e.index])}function $(){const e=ce.history;e.index<e.snapshots.length-1&&N(e.snapshots[++e.index])}function ee(e,t){de.on(e,t)}function te(){r(!0)}function ne(){r(!1)}function oe(){return ce.history.snapshots[ce.history.index]}function se(e){N(e),Y(),T()}const ie="0.1.3",ce={},re=d3.zoom().scaleExtent([.5,2]).on("zoom",n),le=d3.drag().on("drag",l).on("start",function(e){J(e.key)}).on("end",function(){ce.dragged&&(ce.dragged=!1,T())}),de=d3.dispatch("mmcreate","mmcenter","nodedblclick","nodeselect","nodeupdate","nodecreate","noderemove");e.version=ie,e.init=t,e.center=Y,e.undo=Z,e.repeat=$,e.zoomIn=te,e.zoomOut=ne,e.new=W,e.on=ee,e.image=Q,e.data=oe,e.load=se,e.node={update:K,add:X,remove:G,select:J},Object.defineProperty(e,"__esModule",{value:!0})});